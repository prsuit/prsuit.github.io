<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  
  <link rel="stylesheet" href="/lib/animate-css/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Mist","version":"8.0.0-rc.4","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"path":"search.xml"};
  </script>

  <meta name="description" content="前言本文是介绍Android系统启动流程。 目录Android系统架构为了更好理解 Android 系统启动流程，我们需要先了解 Android 系统架构。它分为五层，从下往上依次分为Linux内核、HAL硬件抽象层、系统Native库和Android运行时环境、Java Framework框架层、应用层。如下图所示：">
<meta property="og:type" content="article">
<meta property="og:title" content="Android系统启动-综述">
<meta property="og:url" content="http://yoursite.com/2020/08/14/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8-%E7%BB%BC%E8%BF%B0/index.html">
<meta property="og:site_name" content="SongHang&#39;s Blog">
<meta property="og:description" content="前言本文是介绍Android系统启动流程。 目录Android系统架构为了更好理解 Android 系统启动流程，我们需要先了解 Android 系统架构。它分为五层，从下往上依次分为Linux内核、HAL硬件抽象层、系统Native库和Android运行时环境、Java Framework框架层、应用层。如下图所示：">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gi54x0tvekj30u018640z.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gi386fq0hoj30y80u079p.jpg">
<meta property="article:published_time" content="2020-08-14T13:57:18.000Z">
<meta property="article:modified_time" content="2020-09-02T14:31:34.315Z">
<meta property="article:author" content="prsuit">
<meta property="article:tag" content="Android源码分析">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gi54x0tvekj30u018640z.jpg">

<link rel="canonical" href="http://yoursite.com/2020/08/14/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8-%E7%BB%BC%E8%BF%B0/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Android系统启动-综述 | SongHang's Blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <main class="main">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line toggle-line-first"></span>
        <span class="toggle-line toggle-line-middle"></span>
        <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">SongHang's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#目录"><span class="nav-number">2.</span> <span class="nav-text">目录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Android系统架构"><span class="nav-number">2.1.</span> <span class="nav-text">Android系统架构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动流程概述"><span class="nav-number">2.2.</span> <span class="nav-text">启动流程概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动电源"><span class="nav-number">2.3.</span> <span class="nav-text">启动电源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#执行引导程序BootLoader"><span class="nav-number">2.4.</span> <span class="nav-text">执行引导程序BootLoader</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动内核Kernel"><span class="nav-number">2.5.</span> <span class="nav-text">启动内核Kernel</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动init进程"><span class="nav-number">2.6.</span> <span class="nav-text">启动init进程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#init-main-cpp-main"><span class="nav-number">2.6.1.</span> <span class="nav-text">init&#x2F;main.cpp.main</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#FirstStageMain"><span class="nav-number">2.6.2.</span> <span class="nav-text">FirstStageMain</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SetupSelinux"><span class="nav-number">2.6.3.</span> <span class="nav-text">SetupSelinux</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SecondStageMain"><span class="nav-number">2.6.4.</span> <span class="nav-text">SecondStageMain</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#LoadBootScripts"><span class="nav-number">2.6.5.</span> <span class="nav-text">LoadBootScripts</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ServiceManager"><span class="nav-number">2.7.</span> <span class="nav-text">ServiceManager</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ServiceManager-main"><span class="nav-number">2.7.1.</span> <span class="nav-text">ServiceManager.main</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Zygote"><span class="nav-number">2.8.</span> <span class="nav-text">Zygote</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#init进程启动Zygote流程"><span class="nav-number">2.8.1.</span> <span class="nav-text">init进程启动Zygote流程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#app-process-app-main-cpp-main"><span class="nav-number">2.8.2.</span> <span class="nav-text">app_process&#x2F;app_main.cpp.main</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AndroidRuntime-cpp-start"><span class="nav-number">2.8.3.</span> <span class="nav-text">AndroidRuntime.cpp.start</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ZygoteInit-main"><span class="nav-number">2.8.4.</span> <span class="nav-text">ZygoteInit.main</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ZygoteInit-preload"><span class="nav-number">2.8.5.</span> <span class="nav-text">ZygoteInit.preload</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ZygoteInit-gcAndFinalize"><span class="nav-number">2.8.6.</span> <span class="nav-text">ZygoteInit.gcAndFinalize</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ZygoteInit-zygoteServer"><span class="nav-number">2.8.7.</span> <span class="nav-text">ZygoteInit.zygoteServer</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ZygoteInit-forkSystemServer"><span class="nav-number">2.8.8.</span> <span class="nav-text">ZygoteInit.forkSystemServer</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ZygoteServer-runSelectLoop"><span class="nav-number">2.8.9.</span> <span class="nav-text">ZygoteServer.runSelectLoop</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ZygoteConnection-processOneCommand"><span class="nav-number">2.8.10.</span> <span class="nav-text">ZygoteConnection.processOneCommand</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Zygote-forkAndSpecialize"><span class="nav-number">2.8.11.</span> <span class="nav-text">Zygote.forkAndSpecialize</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ZygoteConnection-handleChildProc"><span class="nav-number">2.8.12.</span> <span class="nav-text">ZygoteConnection.handleChildProc</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ZygoteConnection-handleParentProc"><span class="nav-number">2.8.13.</span> <span class="nav-text">ZygoteConnection.handleParentProc</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SystemServer"><span class="nav-number">2.9.</span> <span class="nav-text">SystemServer</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ZygoteInit-forkSystemServer-1"><span class="nav-number">2.9.1.</span> <span class="nav-text">ZygoteInit.forkSystemServer</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Zygote-forkSystemServer"><span class="nav-number">2.9.2.</span> <span class="nav-text">Zygote.forkSystemServer</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Zygote-nativeForkSystemServer"><span class="nav-number">2.9.3.</span> <span class="nav-text">Zygote.nativeForkSystemServer</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ZygoteInit-handleSystemServerProcess"><span class="nav-number">2.9.4.</span> <span class="nav-text">ZygoteInit.handleSystemServerProcess</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ZygoteInit-zygoteInit"><span class="nav-number">2.9.5.</span> <span class="nav-text">ZygoteInit.zygoteInit</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ZygoteInit-nativeZygoteInit"><span class="nav-number">2.9.6.</span> <span class="nav-text">ZygoteInit.nativeZygoteInit</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#RuntimeInit-applicationInit"><span class="nav-number">2.9.7.</span> <span class="nav-text">RuntimeInit.applicationInit</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#RuntimeInit-findStaticMain"><span class="nav-number">2.9.8.</span> <span class="nav-text">RuntimeInit.findStaticMain</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#MethodAndArgsCaller-run"><span class="nav-number">2.9.9.</span> <span class="nav-text">MethodAndArgsCaller.run</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SystemServer-main"><span class="nav-number">2.9.10.</span> <span class="nav-text">SystemServer.main</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SystemServer-createSystemContext"><span class="nav-number">2.9.11.</span> <span class="nav-text">SystemServer.createSystemContext</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SystemServer-startBootstrapServices"><span class="nav-number">2.9.12.</span> <span class="nav-text">SystemServer.startBootstrapServices</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SystemServer-startCoreServices"><span class="nav-number">2.9.13.</span> <span class="nav-text">SystemServer.startCoreServices</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SystemServer-startOtherServices"><span class="nav-number">2.9.14.</span> <span class="nav-text">SystemServer.startOtherServices</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Launcher"><span class="nav-number">2.10.</span> <span class="nav-text">Launcher</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SystemServer-startOtherServices-1"><span class="nav-number">2.10.1.</span> <span class="nav-text">SystemServer.startOtherServices</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ActivityManagerService-systemReady"><span class="nav-number">2.10.2.</span> <span class="nav-text">ActivityManagerService. systemReady</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ActivityTaskManagerInternal-startHomeOnAllDisplays"><span class="nav-number">2.10.3.</span> <span class="nav-text">ActivityTaskManagerInternal.startHomeOnAllDisplays</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#RootActivityContainer-startHomeOnAllDisplays"><span class="nav-number">2.10.4.</span> <span class="nav-text">RootActivityContainer.startHomeOnAllDisplays</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#RootActivityContainer-startHomeOnDisplay"><span class="nav-number">2.10.5.</span> <span class="nav-text">RootActivityContainer.startHomeOnDisplay</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#RootActivityContainer-startHomeOnDisplay-1"><span class="nav-number">2.10.6.</span> <span class="nav-text">RootActivityContainer.startHomeOnDisplay</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ActivityTaskManagerService-getHomeIntent"><span class="nav-number">2.10.7.</span> <span class="nav-text">ActivityTaskManagerService.getHomeIntent</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ActivityStartController-startHomeActivity"><span class="nav-number">2.10.8.</span> <span class="nav-text">ActivityStartController.startHomeActivity</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ActivityStarter-execute"><span class="nav-number">2.10.9.</span> <span class="nav-text">ActivityStarter.execute</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ActivityStarter-startActivity"><span class="nav-number">2.10.10.</span> <span class="nav-text">ActivityStarter.startActivity</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">prsuit</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">37</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </section>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </header>

      
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div id="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


      <div class="main-inner">
        

        <div class="content post posts-expand">
          

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/14/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8-%E7%BB%BC%E8%BF%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="prsuit">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SongHang's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Android系统启动-综述
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-14 21:57:18" itemprop="dateCreated datePublished" datetime="2020-08-14T21:57:18+08:00">2020-08-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">Android源码分析</span></a>
                </span>
            </span>

          
            <span id="/2020/08/14/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8-%E7%BB%BC%E8%BF%B0/" class="post-meta-item leancloud_visitors" data-flag-title="Android系统启动-综述" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本文是介绍Android系统启动流程。</p>
<h3 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h3><h4 id="Android系统架构"><a href="#Android系统架构" class="headerlink" title="Android系统架构"></a>Android系统架构</h4><p>为了更好理解 Android 系统启动流程，我们需要先了解 Android 系统架构。它分为五层，从下往上依次分为<strong>Linux内核</strong>、<strong>HAL硬件抽象层</strong>、<strong>系统Native库和Android运行时环境</strong>、<strong>Java Framework框架层</strong>、<strong>应用层</strong>。如下图所示：</p>
<a id="more"></a>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gi54x0tvekj30u018640z.jpg" alt=""></p>
<h4 id="启动流程概述"><a href="#启动流程概述" class="headerlink" title="启动流程概述"></a>启动流程概述</h4><p>Android系统的启动，主要是指Android手机长按电源键后，Android手机开机的过程。可分为四步：<strong>启动电源-&gt;执行引导程序BootLoader-&gt;启动内核-&gt;启动Init进程。Init进程启动过程中会启动ServiceManager和Zygote进程，Zygote进程启动过程中通过fork启动SystemServer进程，SystemServer进程启动过程中会开启AMS(ActivityManagerService)等各种系统服务，通过AMS启动系统桌面即Launcher。</strong></p>
<blockquote>
<p>Init进程启动过程：</p>
<ul>
<li>启动ServiceManager—— Binder服务的总管</li>
<li>启动Zygote——Android系统的第一个Java进程(即虚拟机进程)，所有App进程的父进程<ul>
<li>启动SystemServer——Android系统服务的载体，承载framework层核心业务<ul>
<li>启动Launcher——Android系统的“桌面”</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>
<p><strong>系统启动架构图</strong></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gi386fq0hoj30y80u079p.jpg" alt=""></p>
<p><strong>图解：</strong> Android系统启动过程由上图从下往上的一个过程是由BootLoader引导开机，然后依次进入 -&gt; <code>Kernel</code> -&gt; <code>Native</code> -&gt; <code>Framework</code> -&gt; <code>App</code>。</p>
<h4 id="启动电源"><a href="#启动电源" class="headerlink" title="启动电源"></a>启动电源</h4><p>当电源按下，引导芯片从 ROM（一般指 Flash ROM，即闪存）中预定义的位置开始执行，加载引导程序 BootLoader 到 RAM，然后执行。</p>
<h4 id="执行引导程序BootLoader"><a href="#执行引导程序BootLoader" class="headerlink" title="执行引导程序BootLoader"></a>执行引导程序BootLoader</h4><p>Boot Loader是在系统内核运行之前运行的引导程序，也是系统运行的第一个程序。</p>
<p>主要作用是：初始化 RAM、初始化硬件设备、建立内存空间映射图，从而将系统的软硬件环境带到一个合适状态，以便为最终调用操作系统内核准备好正确的环境。</p>
<h4 id="启动内核Kernel"><a href="#启动内核Kernel" class="headerlink" title="启动内核Kernel"></a>启动内核Kernel</h4><p> Linux系统启动主要分为三个阶段：第一个阶段是自解压过程，第二个是设置ARM处理器的工作模式、设置一级页表等，第三个阶段主要是C代码，包括Android的初始化的全部工作。</p>
<p>内核解压缩完成后，通过执行文件<code>head.S</code>、<code>head-common.S</code> 的汇编代码，查找处理器类型和机器码类型来调用相应的初始化函数，然后进入内核入口函数 <code>start_kernel()</code> 开始之后的内核初始化工作，主要是与硬件平台的相关初始化工作。在完成一系列的与内核相关的初始后，调用 <code>rest_init()</code> 函数来进行最后的初始化并创建第一个用户进程 init 进程，由此进入用户态进程。Linux内核启动的最后一个阶段就是挂载根文件系统，因为启动第一个init进程，必须以根文件系统为载体。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//kernel的入口函数start_kernel</span></span><br><span class="line"><span class="function">asmlinkage __visible <span class="keyword">void</span> __init <span class="title">start_kernel</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  rest_init();</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//开启init进程</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> noinline <span class="keyword">void</span> __init_refok <span class="title">rest_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//kernel_init函数在kernel线程中运行</span></span><br><span class="line">  kernel_thread(kernel_init, <span class="literal">NULL</span>, CLONE_FS);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//内核初始化</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __ref <span class="title">kernel_init</span><span class="params">(<span class="keyword">void</span> *unused)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//从下面的路径中找到init进程的可执行文件，</span></span><br><span class="line">  <span class="comment">//并开启用户态的init进程，由内核态进程跳转到用户态进程</span></span><br><span class="line">  <span class="keyword">if</span> (!try_to_run_init_process(<span class="string">"/sbin/init"</span>) || </span><br><span class="line">      !try_to_run_init_process(<span class="string">"/etc/init"</span>) ||</span><br><span class="line">      !try_to_run_init_process(<span class="string">"/bin/init"</span>) ||</span><br><span class="line">      !try_to_run_init_process(<span class="string">"/bin/sh"</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  panic(<span class="string">"No working init found.  Try passing init= option to kernel. "</span></span><br><span class="line">      <span class="string">"See Linux Documentation/init.txt for guidance."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>内核启动时，会设置缓存、被保护存储器、计划列表，加载驱动。当内核完成系统设置，它首先在系统文件中寻找”init”文件，然后启动第一个用户空间进程init进程。</p>
<ul>
<li>启动 Kernel 的 swapper 进程(pid=0)：该进程又称为 idle 进程，系统初始化过程 Kernel 由无到有开创的第一个进程, 用于初始化进程管理、内存管理，加载Display,Camera Driver，Binder Driver等相关工作；</li>
<li>启动 kthreadd 进程（pid=2）：是 Linux 系统的内核进程，会创建内核工作线程 kworkder，软中断线程ksoftirqd，thermal 等内核守护进程。kthreadd 进程是所有内核进程的鼻祖。</li>
</ul>
<h4 id="启动init进程"><a href="#启动init进程" class="headerlink" title="启动init进程"></a>启动init进程</h4><p>Kernel 启动过程会创建 init 进程(pid=1)，是用户空间的第一个进程。内核启动后调用init进程的入口函数main()方法，在<code>system/core/init/main.cpp</code>(注：基于Android 10.0的源码)</p>
<h5 id="init-main-cpp-main"><a href="#init-main-cpp-main" class="headerlink" title="init/main.cpp.main"></a>init/main.cpp.main</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> android::init;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __has_feature(address_sanitizer)</span></span><br><span class="line">    __asan_set_error_report_callback(AsanReportCallback);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(basename(argv[<span class="number">0</span>]), <span class="string">"ueventd"</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> ueventd_main(argc, argv);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"subcontext"</span>)) &#123;</span><br><span class="line">            android::base::InitLogging(argv, &amp;android::base::KernelLogger);</span><br><span class="line">            <span class="keyword">const</span> BuiltinFunctionMap function_map;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> SubcontextMain(argc, argv, &amp;function_map);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"selinux_setup"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> SetupSelinux(argv);<span class="comment">//对SELinux安全机制进行初始化</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"second_stage"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> SecondStageMain(argc, argv);<span class="comment">//第二阶段</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> FirstStageMain(argc, argv); <span class="comment">//第一阶段</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="FirstStageMain"><a href="#FirstStageMain" class="headerlink" title="FirstStageMain"></a>FirstStageMain</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">FirstStageMain</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (REBOOT_BOOTLOADER_ON_PANIC) &#123;</span><br><span class="line">        InstallRebootSignalHandlers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    boot_clock::time_point start_time = boot_clock::now();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="keyword">int</span>&gt;&gt; errors;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CHECKCALL(x) \</span></span><br><span class="line">    <span class="keyword">if</span> (x != <span class="number">0</span>) errors.emplace_back(#x <span class="string">" failed"</span>, errno);</span><br><span class="line">    <span class="comment">// Clear the umask.</span></span><br><span class="line">    umask(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    CHECKCALL(clearenv());</span><br><span class="line">    CHECKCALL(setenv(<span class="string">"PATH"</span>, _PATH_DEFPATH, <span class="number">1</span>));</span><br><span class="line">    <span class="comment">// Get the basic filesystem setup we need put together in the initramdisk</span></span><br><span class="line">    <span class="comment">// on / and then we'll let the rc file figure out the rest.</span></span><br><span class="line">    CHECKCALL(mount(<span class="string">"tmpfs"</span>, <span class="string">"/dev"</span>, <span class="string">"tmpfs"</span>, MS_NOSUID, <span class="string">"mode=0755"</span>));</span><br><span class="line">    CHECKCALL(<span class="built_in">mkdir</span>(<span class="string">"/dev/pts"</span>, <span class="number">0755</span>));</span><br><span class="line">    CHECKCALL(<span class="built_in">mkdir</span>(<span class="string">"/dev/socket"</span>, <span class="number">0755</span>));</span><br><span class="line">    CHECKCALL(mount(<span class="string">"devpts"</span>, <span class="string">"/dev/pts"</span>, <span class="string">"devpts"</span>, <span class="number">0</span>, <span class="literal">NULL</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAKE_STR(x) __STRING(x)</span></span><br><span class="line">    CHECKCALL(mount(<span class="string">"proc"</span>, <span class="string">"/proc"</span>, <span class="string">"proc"</span>, <span class="number">0</span>, <span class="string">"hidepid=2,gid="</span> MAKE_STR(AID_READPROC)));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> MAKE_STR</span></span><br><span class="line">    <span class="comment">// Don't expose the raw commandline to unprivileged processes.</span></span><br><span class="line">    CHECKCALL(chmod(<span class="string">"/proc/cmdline"</span>, <span class="number">0440</span>));</span><br><span class="line">    <span class="keyword">gid_t</span> groups[] = &#123;AID_READPROC&#125;;</span><br><span class="line">    CHECKCALL(setgroups(arraysize(groups), groups));</span><br><span class="line">    CHECKCALL(mount(<span class="string">"sysfs"</span>, <span class="string">"/sys"</span>, <span class="string">"sysfs"</span>, <span class="number">0</span>, <span class="literal">NULL</span>));</span><br><span class="line">    CHECKCALL(mount(<span class="string">"selinuxfs"</span>, <span class="string">"/sys/fs/selinux"</span>, <span class="string">"selinuxfs"</span>, <span class="number">0</span>, <span class="literal">NULL</span>));</span><br><span class="line"></span><br><span class="line">    CHECKCALL(mknod(<span class="string">"/dev/kmsg"</span>, S_IFCHR | <span class="number">0600</span>, makedev(<span class="number">1</span>, <span class="number">11</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(WORLD_WRITABLE_KMSG)</span> </span>&#123;</span><br><span class="line">        CHECKCALL(mknod(<span class="string">"/dev/kmsg_debug"</span>, S_IFCHR | <span class="number">0622</span>, makedev(<span class="number">1</span>, <span class="number">11</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CHECKCALL(mknod(<span class="string">"/dev/random"</span>, S_IFCHR | <span class="number">0666</span>, makedev(<span class="number">1</span>, <span class="number">8</span>)));</span><br><span class="line">    CHECKCALL(mknod(<span class="string">"/dev/urandom"</span>, S_IFCHR | <span class="number">0666</span>, makedev(<span class="number">1</span>, <span class="number">9</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is needed for log wrapper, which gets called before ueventd runs.</span></span><br><span class="line">    CHECKCALL(mknod(<span class="string">"/dev/ptmx"</span>, S_IFCHR | <span class="number">0666</span>, makedev(<span class="number">5</span>, <span class="number">2</span>)));</span><br><span class="line">    CHECKCALL(mknod(<span class="string">"/dev/null"</span>, S_IFCHR | <span class="number">0666</span>, makedev(<span class="number">1</span>, <span class="number">3</span>)));</span><br><span class="line"></span><br><span class="line">    CHECKCALL(mount(<span class="string">"tmpfs"</span>, <span class="string">"/mnt"</span>, <span class="string">"tmpfs"</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class="line">                    <span class="string">"mode=0755,uid=0,gid=1000"</span>));</span><br><span class="line">    <span class="comment">// /mnt/vendor is used to mount vendor-specific partitions that can not be</span></span><br><span class="line">    <span class="comment">// part of the vendor partition, e.g. because they are mounted read-write.</span></span><br><span class="line">    CHECKCALL(<span class="built_in">mkdir</span>(<span class="string">"/mnt/vendor"</span>, <span class="number">0755</span>));</span><br><span class="line">    <span class="comment">// /mnt/product is used to mount product-specific partitions that can not be</span></span><br><span class="line">    <span class="comment">// part of the product partition, e.g. because they are mounted read-write.</span></span><br><span class="line">    CHECKCALL(<span class="built_in">mkdir</span>(<span class="string">"/mnt/product"</span>, <span class="number">0755</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// /apex is used to mount APEXes</span></span><br><span class="line">    CHECKCALL(mount(<span class="string">"tmpfs"</span>, <span class="string">"/apex"</span>, <span class="string">"tmpfs"</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class="line">                    <span class="string">"mode=0755,uid=0,gid=0"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// /debug_ramdisk is used to preserve additional files from the debug ramdisk</span></span><br><span class="line">    CHECKCALL(mount(<span class="string">"tmpfs"</span>, <span class="string">"/debug_ramdisk"</span>, <span class="string">"tmpfs"</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class="line">                    <span class="string">"mode=0755,uid=0,gid=0"</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> CHECKCALL</span></span><br><span class="line"></span><br><span class="line">    SetStdioToDevNull(argv);</span><br><span class="line">    <span class="comment">// Now that tmpfs is mounted on /dev and we have /dev/kmsg, we can actually</span></span><br><span class="line">    <span class="comment">// talk to the outside world...</span></span><br><span class="line">    InitKernelLogging(argv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!errors.empty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [error_string, error_errno] : errors) &#123;</span><br><span class="line">            LOG(ERROR) &lt;&lt; error_string &lt;&lt; <span class="string">" "</span> &lt;&lt; strerror(error_errno);</span><br><span class="line">        &#125;</span><br><span class="line">        LOG(FATAL) &lt;&lt; <span class="string">"Init encountered errors starting first stage, aborting"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LOG(INFO) &lt;&lt; <span class="string">"init first stage started!"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> old_root_dir = <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;DIR, <span class="keyword">decltype</span>(&amp;closedir)&gt;&#123;opendir(<span class="string">"/"</span>), closedir&#125;;</span><br><span class="line">    <span class="keyword">if</span> (!old_root_dir) &#123;</span><br><span class="line">        PLOG(ERROR) &lt;&lt; <span class="string">"Could not opendir(\"/\"), not freeing ramdisk"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">old_root_info</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (stat(<span class="string">"/"</span>, &amp;old_root_info) != <span class="number">0</span>) &#123;</span><br><span class="line">        PLOG(ERROR) &lt;&lt; <span class="string">"Could not stat(\"/\"), not freeing ramdisk"</span>;</span><br><span class="line">        old_root_dir.reset();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ForceNormalBoot()) &#123;</span><br><span class="line">        <span class="built_in">mkdir</span>(<span class="string">"/first_stage_ramdisk"</span>, <span class="number">0755</span>);</span><br><span class="line">        <span class="comment">// SwitchRoot() must be called with a mount point as the target, so we bind mount the</span></span><br><span class="line">        <span class="comment">// target directory to itself here.</span></span><br><span class="line">        <span class="keyword">if</span> (mount(<span class="string">"/first_stage_ramdisk"</span>, <span class="string">"/first_stage_ramdisk"</span>, <span class="literal">nullptr</span>, MS_BIND, <span class="literal">nullptr</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            LOG(FATAL) &lt;&lt; <span class="string">"Could not bind mount /first_stage_ramdisk to itself"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        SwitchRoot(<span class="string">"/first_stage_ramdisk"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If this file is present, the second-stage init will use a userdebug sepolicy</span></span><br><span class="line">    <span class="comment">// and load adb_debug.prop to allow adb root, if the device is unlocked.</span></span><br><span class="line">    <span class="keyword">if</span> (access(<span class="string">"/force_debuggable"</span>, F_OK) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::error_code ec;  <span class="comment">// to invoke the overloaded copy_file() that won't throw.</span></span><br><span class="line">        <span class="keyword">if</span> (!fs::copy_file(<span class="string">"/adb_debug.prop"</span>, kDebugRamdiskProp, ec) ||</span><br><span class="line">            !fs::copy_file(<span class="string">"/userdebug_plat_sepolicy.cil"</span>, kDebugRamdiskSEPolicy, ec)) &#123;</span><br><span class="line">            LOG(ERROR) &lt;&lt; <span class="string">"Failed to setup debug ramdisk"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// setenv for second-stage init to read above kDebugRamdisk* files.</span></span><br><span class="line">            setenv(<span class="string">"INIT_FORCE_DEBUGGABLE"</span>, <span class="string">"true"</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!DoFirstStageMount()) &#123;</span><br><span class="line">        LOG(FATAL) &lt;&lt; <span class="string">"Failed to mount required partitions early ..."</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">new_root_info</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (stat(<span class="string">"/"</span>, &amp;new_root_info) != <span class="number">0</span>) &#123;</span><br><span class="line">        PLOG(ERROR) &lt;&lt; <span class="string">"Could not stat(\"/\"), not freeing ramdisk"</span>;</span><br><span class="line">        old_root_dir.reset();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (old_root_dir &amp;&amp; old_root_info.st_dev != new_root_info.st_dev) &#123;</span><br><span class="line">        FreeRamdisk(old_root_dir.<span class="built_in">get</span>(), old_root_info.st_dev);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SetInitAvbVersionInRecovery();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">uint32_t</span> kNanosecondsPerMillisecond = <span class="number">1e6</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> start_ms = start_time.time_since_epoch().count() / kNanosecondsPerMillisecond;</span><br><span class="line">    setenv(<span class="string">"INIT_STARTED_AT"</span>, <span class="built_in">std</span>::to_string(start_ms).c_str(), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* path = <span class="string">"/system/bin/init"</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* args[] = &#123;path, <span class="string">"selinux_setup"</span>, <span class="literal">nullptr</span>&#125;;</span><br><span class="line">    execv(path, <span class="keyword">const_cast</span>&lt;<span class="keyword">char</span>**&gt;(args));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// execv() only returns if an error happened, in which case we</span></span><br><span class="line">    <span class="comment">// panic and never fall through this conditional.</span></span><br><span class="line">    PLOG(FATAL) &lt;&lt; <span class="string">"execv(\""</span> &lt;&lt; path &lt;&lt; <span class="string">"\") failed"</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="SetupSelinux"><a href="#SetupSelinux" class="headerlink" title="SetupSelinux"></a>SetupSelinux</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This function initializes SELinux then execs init to run in the init SELinux context.</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">SetupSelinux</span><span class="params">(<span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    InitKernelLogging(argv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (REBOOT_BOOTLOADER_ON_PANIC) &#123;</span><br><span class="line">        InstallRebootSignalHandlers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set up SELinux, loading the SELinux policy.</span></span><br><span class="line">    SelinuxSetupKernelLogging();</span><br><span class="line">    SelinuxInitialize();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We're in the kernel domain and want to transition to the init domain.  File systems that</span></span><br><span class="line">    <span class="comment">// store SELabels in their xattrs, such as ext4 do not need an explicit restorecon here,</span></span><br><span class="line">    <span class="comment">// but other file systems do.  In particular, this is needed for ramdisks such as the</span></span><br><span class="line">    <span class="comment">// recovery image for A/B devices.</span></span><br><span class="line">    <span class="keyword">if</span> (selinux_android_restorecon(<span class="string">"/system/bin/init"</span>, <span class="number">0</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        PLOG(FATAL) &lt;&lt; <span class="string">"restorecon failed of /system/bin/init failed"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* path = <span class="string">"/system/bin/init"</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* args[] = &#123;path, <span class="string">"second_stage"</span>, <span class="literal">nullptr</span>&#125;;</span><br><span class="line">    execv(path, <span class="keyword">const_cast</span>&lt;<span class="keyword">char</span>**&gt;(args));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// execv() only returns if an error happened, in which case we</span></span><br><span class="line">    <span class="comment">// panic and never return from this function.</span></span><br><span class="line">    PLOG(FATAL) &lt;&lt; <span class="string">"execv(\""</span> &lt;&lt; path &lt;&lt; <span class="string">"\") failed"</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="SecondStageMain"><a href="#SecondStageMain" class="headerlink" title="SecondStageMain"></a>SecondStageMain</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">SecondStageMain</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (REBOOT_BOOTLOADER_ON_PANIC) &#123;</span><br><span class="line">        InstallRebootSignalHandlers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SetStdioToDevNull(argv);</span><br><span class="line">    InitKernelLogging(argv);</span><br><span class="line">    LOG(INFO) &lt;&lt; <span class="string">"init second stage started!"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set init and its forked children's oom_adj.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">auto</span> result = WriteFile(<span class="string">"/proc/1/oom_score_adj"</span>, <span class="string">"-1000"</span>); !result) &#123;</span><br><span class="line">        LOG(ERROR) &lt;&lt; <span class="string">"Unable to write -1000 to /proc/1/oom_score_adj: "</span> &lt;&lt; result.error();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enable seccomp if global boot option was passed (otherwise it is enabled in zygote).</span></span><br><span class="line">    GlobalSeccomp();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set up a session keyring that all processes will have access to. It</span></span><br><span class="line">    <span class="comment">// will hold things like FBE encryption keys. No process should override</span></span><br><span class="line">    <span class="comment">// its session keyring.</span></span><br><span class="line">    keyctl_get_keyring_ID(KEY_SPEC_SESSION_KEYRING, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Indicate that booting is in progress to background fw loaders, etc.</span></span><br><span class="line">    <span class="built_in">close</span>(<span class="built_in">open</span>(<span class="string">"/dev/.booting"</span>, O_WRONLY | O_CREAT | O_CLOEXEC, <span class="number">0000</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化属性相关资源</span></span><br><span class="line">    property_init();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If arguments are passed both on the command line and in DT,</span></span><br><span class="line">    <span class="comment">// properties set in DT always have priority over the command-line ones.</span></span><br><span class="line">    process_kernel_dt();</span><br><span class="line">    process_kernel_cmdline();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Propagate the kernel variables to internal variables</span></span><br><span class="line">    <span class="comment">// used by init as well as the current required properties.</span></span><br><span class="line">    export_kernel_boot_props();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make the time that init started available for bootstat to log.</span></span><br><span class="line">    property_set(<span class="string">"ro.boottime.init"</span>, getenv(<span class="string">"INIT_STARTED_AT"</span>));</span><br><span class="line">    property_set(<span class="string">"ro.boottime.init.selinux"</span>, getenv(<span class="string">"INIT_SELINUX_TOOK"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set libavb version for Framework-only OTA match in Treble build.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* avb_version = getenv(<span class="string">"INIT_AVB_VERSION"</span>);</span><br><span class="line">    <span class="keyword">if</span> (avb_version) property_set(<span class="string">"ro.boot.avb_version"</span>, avb_version);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// See if need to load debug props to allow adb root, when the device is unlocked.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* force_debuggable_env = getenv(<span class="string">"INIT_FORCE_DEBUGGABLE"</span>);</span><br><span class="line">    <span class="keyword">if</span> (force_debuggable_env &amp;&amp; AvbHandle::IsDeviceUnlocked()) &#123;</span><br><span class="line">        load_debug_prop = <span class="string">"true"</span>s == force_debuggable_env;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clean up our environment.</span></span><br><span class="line">    unsetenv(<span class="string">"INIT_STARTED_AT"</span>);</span><br><span class="line">    unsetenv(<span class="string">"INIT_SELINUX_TOOK"</span>);</span><br><span class="line">    unsetenv(<span class="string">"INIT_AVB_VERSION"</span>);</span><br><span class="line">    unsetenv(<span class="string">"INIT_FORCE_DEBUGGABLE"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now set up SELinux for second stage.</span></span><br><span class="line">    SelinuxSetupKernelLogging();</span><br><span class="line">    SelabelInitialize();</span><br><span class="line">    SelinuxRestoreContext();</span><br><span class="line"></span><br><span class="line">    Epoll epoll;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">auto</span> result = epoll.Open(); !result) &#123;</span><br><span class="line">        PLOG(FATAL) &lt;&lt; result.error();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置子信号处理函数</span></span><br><span class="line">    InstallSignalFdHandler(&amp;epoll);</span><br><span class="line">    <span class="comment">//导入默认的环境变量</span></span><br><span class="line">    property_load_boot_defaults(load_debug_prop);</span><br><span class="line">    UmountDebugRamdisk();</span><br><span class="line">    fs_mgr_vendor_overlay_mount_all();</span><br><span class="line">    export_oem_lock_status();</span><br><span class="line">    <span class="comment">//启动属性服务</span></span><br><span class="line">    StartPropertyService(&amp;epoll);</span><br><span class="line">    <span class="function">MountHandler <span class="title">mount_handler</span><span class="params">(&amp;epoll)</span></span>;</span><br><span class="line">    set_usb_controller();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> BuiltinFunctionMap function_map;</span><br><span class="line">    Action::set_function_map(&amp;function_map);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!SetupMountNamespaces()) &#123;</span><br><span class="line">        PLOG(FATAL) &lt;&lt; <span class="string">"SetupMountNamespaces failed"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    subcontexts = InitializeSubcontexts();</span><br><span class="line"></span><br><span class="line">    ActionManager&amp; am = ActionManager::GetInstance();</span><br><span class="line">    ServiceList&amp; sm = ServiceList::GetInstance();</span><br><span class="line">    <span class="comment">//加载引导脚本</span></span><br><span class="line">    LoadBootScripts(am, sm);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Turning this on and letting the INFO logging be discarded adds 0.2s to</span></span><br><span class="line">    <span class="comment">// Nexus 9 boot time, so it's disabled by default.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span>) DumpState();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make the GSI status available before scripts start running.</span></span><br><span class="line">    <span class="keyword">if</span> (android::gsi::IsGsiRunning()) &#123;</span><br><span class="line">        property_set(<span class="string">"ro.gsid.image_running"</span>, <span class="string">"1"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        property_set(<span class="string">"ro.gsid.image_running"</span>, <span class="string">"0"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    am.QueueBuiltinAction(SetupCgroupsAction, <span class="string">"SetupCgroups"</span>);</span><br><span class="line"></span><br><span class="line">    am.QueueEventTrigger(<span class="string">"early-init"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Queue an action that waits for coldboot done so we know ueventd has set up all of /dev...</span></span><br><span class="line">    am.QueueBuiltinAction(wait_for_coldboot_done_action, <span class="string">"wait_for_coldboot_done"</span>);</span><br><span class="line">    <span class="comment">// ... so that we can start queuing up actions that require stuff from /dev.</span></span><br><span class="line">    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, <span class="string">"MixHwrngIntoLinuxRng"</span>);</span><br><span class="line">    am.QueueBuiltinAction(SetMmapRndBitsAction, <span class="string">"SetMmapRndBits"</span>);</span><br><span class="line">    am.QueueBuiltinAction(SetKptrRestrictAction, <span class="string">"SetKptrRestrict"</span>);</span><br><span class="line">    Keychords keychords;</span><br><span class="line">    am.QueueBuiltinAction(</span><br><span class="line">        [&amp;epoll, &amp;keychords](<span class="keyword">const</span> BuiltinArguments&amp; args) -&gt; Result&lt;Success&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; svc : ServiceList::GetInstance()) &#123;</span><br><span class="line">                keychords.Register(svc-&gt;keycodes());</span><br><span class="line">            &#125;</span><br><span class="line">            keychords.Start(&amp;epoll, HandleKeychord);</span><br><span class="line">            <span class="keyword">return</span> Success();</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"KeychordInit"</span>);</span><br><span class="line">    am.QueueBuiltinAction(console_init_action, <span class="string">"console_init"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Trigger all the boot actions to get us started.</span></span><br><span class="line">    am.QueueEventTrigger(<span class="string">"init"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Starting the BoringSSL self test, for NIAP certification compliance.</span></span><br><span class="line">    am.QueueBuiltinAction(StartBoringSslSelfTest, <span class="string">"StartBoringSslSelfTest"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Repeat mix_hwrng_into_linux_rng in case /dev/hw_random or /dev/random</span></span><br><span class="line">    <span class="comment">// wasn't ready immediately after wait_for_coldboot_done</span></span><br><span class="line">    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, <span class="string">"MixHwrngIntoLinuxRng"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize binder before bringing up other system services</span></span><br><span class="line">    am.QueueBuiltinAction(InitBinder, <span class="string">"InitBinder"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Don't mount filesystems or start core system services in charger mode.</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> bootmode = GetProperty(<span class="string">"ro.bootmode"</span>, <span class="string">""</span>);</span><br><span class="line">    <span class="keyword">if</span> (bootmode == <span class="string">"charger"</span>) &#123;</span><br><span class="line">        am.QueueEventTrigger(<span class="string">"charger"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        am.QueueEventTrigger(<span class="string">"late-init"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Run all property triggers based on current state of the properties.</span></span><br><span class="line">    am.QueueBuiltinAction(queue_property_triggers_action, <span class="string">"queue_property_triggers"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// By default, sleep until something happens.</span></span><br><span class="line">        <span class="keyword">auto</span> epoll_timeout = <span class="built_in">std</span>::optional&lt;<span class="built_in">std</span>::chrono::milliseconds&gt;&#123;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (do_shutdown &amp;&amp; !shutting_down) &#123;</span><br><span class="line">            do_shutdown = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (HandlePowerctlMessage(shutdown_command)) &#123;</span><br><span class="line">                shutting_down = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class="line">            <span class="comment">//内部会执行每个action中携带的command对应的执行函数</span></span><br><span class="line">            am.ExecuteOneCommand();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!shutting_down) &#123;</span><br><span class="line">                <span class="keyword">auto</span> next_process_action_time = HandleProcessActions();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// If there's a process that needs restarting, wake up in time for that.</span></span><br><span class="line">                <span class="keyword">if</span> (next_process_action_time) &#123;</span><br><span class="line">                    epoll_timeout = <span class="built_in">std</span>::chrono::<span class="built_in">ceil</span>&lt;<span class="built_in">std</span>::chrono::milliseconds&gt;(</span><br><span class="line">                            *next_process_action_time - boot_clock::now());</span><br><span class="line">                    <span class="keyword">if</span> (*epoll_timeout &lt; <span class="number">0</span>ms) epoll_timeout = <span class="number">0</span>ms;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If there's more work to do, wake up again immediately.</span></span><br><span class="line">            <span class="keyword">if</span> (am.HasMoreCommands()) epoll_timeout = <span class="number">0</span>ms;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">auto</span> result = epoll.Wait(epoll_timeout); !result) &#123;</span><br><span class="line">            LOG(ERROR) &lt;&lt; result.error();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="LoadBootScripts"><a href="#LoadBootScripts" class="headerlink" title="LoadBootScripts"></a>LoadBootScripts</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//加载引导脚本</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">LoadBootScripts</span><span class="params">(ActionManager&amp; action_manager, ServiceList&amp; service_list)</span> </span>&#123;</span><br><span class="line">    Parser parser = CreateParser(action_manager, service_list);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> bootscript = GetProperty(<span class="string">"ro.boot.init_rc"</span>, <span class="string">""</span>);</span><br><span class="line">    <span class="keyword">if</span> (bootscript.empty()) &#123;</span><br><span class="line">        <span class="comment">//解析init.rc配置文件</span></span><br><span class="line">        parser.ParseConfig(<span class="string">"/init.rc"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!parser.ParseConfig(<span class="string">"/system/etc/init"</span>)) &#123;</span><br><span class="line">            late_import_paths.emplace_back(<span class="string">"/system/etc/init"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!parser.ParseConfig(<span class="string">"/product/etc/init"</span>)) &#123;</span><br><span class="line">            late_import_paths.emplace_back(<span class="string">"/product/etc/init"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!parser.ParseConfig(<span class="string">"/product_services/etc/init"</span>)) &#123;</span><br><span class="line">            late_import_paths.emplace_back(<span class="string">"/product_services/etc/init"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!parser.ParseConfig(<span class="string">"/odm/etc/init"</span>)) &#123;</span><br><span class="line">            late_import_paths.emplace_back(<span class="string">"/odm/etc/init"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!parser.ParseConfig(<span class="string">"/vendor/etc/init"</span>)) &#123;</span><br><span class="line">            late_import_paths.emplace_back(<span class="string">"/vendor/etc/init"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        parser.ParseConfig(bootscript);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>init进程的执行过程，调用init.main()方法：</p>
<ol>
<li>创建和挂载启动所需的文件目录</li>
<li>处理子进程的终止(signal信号量方式)</li>
<li>初始化和启动属性服务</li>
<li>解析init.rc配置文件并启动Zygote进程</li>
</ol>
<p>注：init.rc 是Android初始化语言编写的一个非常重要的配置脚本文件。它主要包含五种类型语句：Action、Commands、Services、Options和Import。 ServiceManager进程和Zygote进程都是由init进程解析init.rc中特定的语句启动的。</p>
<h4 id="ServiceManager"><a href="#ServiceManager" class="headerlink" title="ServiceManager"></a>ServiceManager</h4><p>servicemanager 进程是由 init 进程通过解析 init.rc 文件(位于<code>system/core/rootdir/</code>)来启动的。从Android 5.0开始中对 init.rc 文件进行了拆分，每个服务一个rc文件。ServiceManager的启动脚本文件<code>frameworks/native/cmds/servicemanager/servicemanager.rc</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">service servicemanager /system/bin/servicemanager</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">core</span> <span class="title">animation</span></span></span><br><span class="line"><span class="class">    <span class="title">user</span> <span class="title">system</span> //1</span></span><br><span class="line"><span class="class">    <span class="title">group</span> <span class="title">system</span> <span class="title">readproc</span></span></span><br><span class="line"><span class="class">    <span class="title">critical</span> //2</span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">healthd</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">zygote</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">audioserver</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">media</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">surfaceflinger</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">inputflinger</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">drm</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">cameraserver</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">keystore</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">gatekeeperd</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">thermalservice</span></span></span><br><span class="line"><span class="class">    <span class="title">writepid</span> /<span class="title">dev</span>/<span class="title">cpuset</span>/<span class="title">system</span>-<span class="title">background</span>/<span class="title">tasks</span></span></span><br><span class="line"><span class="class">    <span class="title">shutdown</span> <span class="title">critical</span></span></span><br></pre></td></tr></table></figure>

<p>service用于通知init进程创建名为servicemanager的进程，这个servicemanager进程执行程序的路径为<code>/system/bin/servicemanager</code>。</p>
<p>注释1的关键字user说明servicemanager是以用户system的身份运行的，注释2处的critical说明servicemanager是系统中的关键服务，关键服务是不会退出的，如果退出了，系统就会重启，当系统重启时就会启动用onrestart关键字修饰的进程，比如zygote、media、surfaceflinger等。</p>
<h5 id="ServiceManager-main"><a href="#ServiceManager-main" class="headerlink" title="ServiceManager.main"></a>ServiceManager.main</h5><p>servicemanager 入口函数在 <code>framework/native/cmds/servicemanager/service_manager.c</code>，简化后的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_state</span> *<span class="title">bs</span>;</span></span><br><span class="line">    <span class="comment">// 打开binder驱动，申请 128k 字节大小的内存空间</span></span><br><span class="line">    bs = binder_open(<span class="number">128</span>*<span class="number">1024</span>);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 成为上下文管理者</span></span><br><span class="line">    <span class="keyword">if</span> (binder_become_context_manager(bs)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证 selinux 权限，判断进程是否有权注册或查看指定服务</span></span><br><span class="line">    selinux_enabled = is_selinux_enabled();</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 进入无限循环，处理 client 端发来的请求 </span></span><br><span class="line">    binder_loop(bs, svcmgr_handler);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里重点关注两点，首先，在申请了一块大小为 128k 的内存空间并验证 selinux 权限后，接着调用 <code>framework/native/cmds/servicemanager/binder.c</code> 中的 binder_become_context_manager 方法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binder_become_context_manager</span><span class="params">(struct binder_state *bs)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 通过ioctl，发送 BINDER_SET_CONTEXT_MGR 指令</span></span><br><span class="line">    <span class="keyword">return</span> ioctl(bs-&gt;fd, BINDER_SET_CONTEXT_MGR, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，调用 binder_loop 方法进入循环来处理 client 发来的请求，注意第二个参数是一个方法体，用于处理各种状态回调：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">svcmgr_handler</span><span class="params">(...)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(txn-&gt;code) &#123;</span><br><span class="line">    <span class="keyword">case</span> SVC_MGR_GET_SERVICE:</span><br><span class="line">    <span class="keyword">case</span> SVC_MGR_CHECK_SERVICE: </span><br><span class="line">        <span class="comment">// 获取服务名</span></span><br><span class="line">        s = bio_get_string16(msg, &amp;len); </span><br><span class="line">        <span class="comment">// 根据名称查找相应服务</span></span><br><span class="line">        handle = do_find_service(bs, s, len, txn-&gt;sender_euid, txn-&gt;sender_pid);</span><br><span class="line">        bio_put_ref(reply, handle);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> SVC_MGR_ADD_SERVICE: </span><br><span class="line">        <span class="comment">// 获取服务名</span></span><br><span class="line">        s = bio_get_string16(msg, &amp;len);</span><br><span class="line">        handle = bio_get_ref(msg);</span><br><span class="line">        allow_isolated = bio_get_uint32(msg) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">         <span class="comment">// 注册指定服务</span></span><br><span class="line">        <span class="keyword">if</span> (do_add_service(bs, s, len, handle, txn-&gt;sender_euid,</span><br><span class="line">            allow_isolated, txn-&gt;sender_pid))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结一下ServiceManager 进程启动过程：</p>
<ol>
<li>调用 binder_open 方法打开 Binder 驱动，并申请分配一块 128k 的内存空间</li>
<li>调用 binder_become_context_manager 方法发送 BINDER_SET_CONTEXT_MGR 给 Binder 驱动，使自己成为上下文管理者</li>
<li>验证 selinux 权限，判断进程是否有注册或查看指定服务的权限</li>
<li>调用 binder_loop 方法进入循环状态，等待 Client 请求</li>
<li>根据服务名称注册服务·</li>
<li>接收 Binder 死亡通知</li>
</ol>
<h4 id="Zygote"><a href="#Zygote" class="headerlink" title="Zygote"></a>Zygote</h4><p>Zygote进程在init进程中以<strong>service</strong>的方式启动的，由 init 进程通过解析 init.rc 文件来启动的。init.rc 并不是直接引入某个固定的文件，而是根据属性ro.zygote的内容来引入不同的文件。这是因为从Android 5.0开始，Android系统开始支持64位的编译，Zygote进程本身也会有32位和64位版本的区别。所以在init.rc的同级目录<code>system/core/rootdir/</code>下一共有4个和zygote相关的rc文件：</p>
<blockquote>
<ul>
<li>init.zygote32</li>
<li>init.zygote64</li>
<li>init.zygote32_64</li>
<li>init.zygote64_32</li>
</ul>
</blockquote>
<p>init.zygote32.rc：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">main</span></span></span><br><span class="line"><span class="class">    <span class="title">priority</span> -20</span></span><br><span class="line"><span class="class">    <span class="title">user</span> <span class="title">root</span></span></span><br><span class="line"><span class="class">    <span class="title">group</span> <span class="title">root</span> <span class="title">readproc</span> <span class="title">reserved_disk</span></span></span><br><span class="line"><span class="class">    <span class="title">socket</span> <span class="title">zygote</span> <span class="title">stream</span> 660 <span class="title">root</span> <span class="title">system</span></span></span><br><span class="line"><span class="class">    <span class="title">socket</span> <span class="title">usap_pool_primary</span> <span class="title">stream</span> 660 <span class="title">root</span> <span class="title">system</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">write</span> /<span class="title">sys</span>/<span class="title">android_power</span>/<span class="title">request_state</span> <span class="title">wake</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">write</span> /<span class="title">sys</span>/<span class="title">power</span>/<span class="title">state</span> <span class="title">on</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">audioserver</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">cameraserver</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">media</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">netd</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">wificond</span></span></span><br><span class="line"><span class="class">    <span class="title">writepid</span> /<span class="title">dev</span>/<span class="title">cpuset</span>/<span class="title">foreground</span>/<span class="title">tasks</span></span></span><br></pre></td></tr></table></figure>

<p>init.zygote32_64.rc：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">service zygote /system/bin/app_process32 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote</span><br><span class="line">    class main</span><br><span class="line">    priority <span class="number">-20</span></span><br><span class="line">    user root</span><br><span class="line">    group root readproc reserved_disk</span><br><span class="line">    socket zygote stream <span class="number">660</span> root system</span><br><span class="line">    socket usap_pool_primary stream <span class="number">660</span> root system</span><br><span class="line">    onrestart <span class="built_in">write</span> /sys/android_power/request_state wake</span><br><span class="line">    onrestart <span class="built_in">write</span> /sys/power/state on</span><br><span class="line">    onrestart restart audioserver</span><br><span class="line">    onrestart restart cameraserver</span><br><span class="line">    onrestart restart media</span><br><span class="line">    onrestart restart netd</span><br><span class="line">    onrestart restart wificond</span><br><span class="line">    writepid /dev/cpuset/foreground/tasks</span><br><span class="line"></span><br><span class="line">service zygote_secondary /system/bin/app_process64 -Xzygote /system/bin --zygote --socket-name=zygote_secondary</span><br><span class="line">    class main</span><br><span class="line">    priority <span class="number">-20</span></span><br><span class="line">    user root</span><br><span class="line">    group root readproc reserved_disk</span><br><span class="line">    socket zygote_secondary stream <span class="number">660</span> root system</span><br><span class="line">    socket usap_pool_secondary stream <span class="number">660</span> root system</span><br><span class="line">    onrestart restart zygote</span><br><span class="line">    writepid /dev/cpuset/foreground/tasks</span><br></pre></td></tr></table></figure>

<p>从init.zygote32_64.rc 文件可以看到，这种情况下系统定义了两个zygote 服务：<strong>zygote</strong>和<strong>zygote_secodary</strong>。这两个服务最大的区别是启动的可执行文件不同，一个是app_process32，一个是app_process64。所以从这里我们可以知道，Andorid系统支持4种运行模式：</p>
<blockquote>
<p>纯32位模式：属性ro.zygote的值为zygote32</p>
<p>混32位模式(即32位为主，64位为辅)模式：属性ro.zygote的值为zygote32_64</p>
<p>纯64位模式：属性ro.zygote的值为zygote64</p>
<p>混64位模式(即 64位为主，32位为辅)模式：属性ro.zygote值为zygote64_32</p>
</blockquote>
<h5 id="init进程启动Zygote流程"><a href="#init进程启动Zygote流程" class="headerlink" title="init进程启动Zygote流程"></a>init进程启动Zygote流程</h5><p>先看到init.rc的这部分配置代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">on nonencrypted    </span><br><span class="line">    exec - root -- &#x2F;system&#x2F;bin&#x2F;update_verifier nonencrypted  </span><br><span class="line">    &#x2F;&#x2F; 1</span><br><span class="line">    class_start main         </span><br><span class="line">    class_start late_start </span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>1.使用class_start这个COMMAND去启动Zygote。其中class_start对应do_class_start()函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">static Result&lt;Success&gt; do_class_start(const BuiltinArguments&amp; args) &#123;</span><br><span class="line">    &#x2F;&#x2F; Starting a class does not start services which are explicitly disabled.</span><br><span class="line">    &#x2F;&#x2F; They must be started individually.</span><br><span class="line">    for (const auto&amp; service : ServiceList::GetInstance()) &#123;</span><br><span class="line">        if (service-&gt;classnames().count(args[1])) &#123;</span><br><span class="line">            &#x2F;&#x2F; 2</span><br><span class="line">            if (auto result &#x3D; service-&gt;StartIfNotDisabled(); !result) &#123;</span><br><span class="line">                LOG(ERROR) &lt;&lt; &quot;Could not start service&#39;&quot; &lt;&lt; service-&gt;name()</span><br><span class="line">                           &lt;&lt; &quot;&#39; as part of class &#39;&quot; &lt;&lt;  args[1] &lt;&lt; &quot;&#39;: &quot; &lt;&lt;  result.error();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return Success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.在system/core/init/builtins.cpp的do_class_start()函数中会遍历前面的Vector类型的Service链表，找到classname为main的Zygote，并调用system/core/init/service.cpp中的startIfNotDisabled()函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bool Service::StartIfNotDisabled() &#123;</span><br><span class="line">    if (!(flags_ &amp; SVC_DISABLED)) &#123;</span><br><span class="line">        return Start();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        flags_ |&#x3D; SVC_DISABLED_START;</span><br><span class="line">    &#125;</span><br><span class="line">    return Success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.如果Service没有再其对应的rc文件中设置disabled选项，则会调用Start()启动该Service。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Service::Start</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (flags_ &amp; SVC_RUNNING) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((flags_ &amp; SVC_ONESHOT) &amp;&amp; disabled) &#123;</span><br><span class="line">            flags_ |= SVC_RESTART;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果不是一个错误，尝试去启动一个已经启动的服务</span></span><br><span class="line">        <span class="keyword">return</span> Success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断需要启动的Service的对应的执行文件是否存在，不存在则不启动该Service</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">sb</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (stat(args_[<span class="number">0</span>].c_str(), &amp;sb) == <span class="number">-1</span>) &#123;</span><br><span class="line">        flags_ |= SVC_DISABLED;</span><br><span class="line">        <span class="keyword">return</span> ErrnoError() &lt;&lt; <span class="string">"Cannot find '"</span> &lt;&lt; args_[<span class="number">0</span>] &lt;&lt; <span class="string">"'"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fork函数创建子进程</span></span><br><span class="line">    <span class="keyword">pid_t</span> pid = fork();</span><br><span class="line">    <span class="comment">// 运行在子进程中</span></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        umask(<span class="number">077</span>);</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在ExpandArgsAndExecv函数里进行了参数装配并使用了execv()执行程序</span></span><br><span class="line">        <span class="keyword">if</span> (!ExpandArgsAndExecv(args_)) &#123;</span><br><span class="line">            PLOG(ERROR) &lt;&lt; <span class="string">"cannot execve('"</span> &lt;&lt; args_[<span class="number">0</span>] &lt;&lt; <span class="string">"')"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">         _exit(<span class="number">127</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">ExpandArgsAndExecv</span><span class="params">(cons <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; args)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; expanded_args;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">char</span>*&gt; c_strings;</span><br><span class="line"></span><br><span class="line">    expanded_args.resize(args.<span class="built_in">size</span>());</span><br><span class="line">    c_strings.push_back(<span class="keyword">const_cast</span>&lt;<span class="keyword">char</span>*&gt;(args[<span class="number">0</span>].data()));</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">std</span>::<span class="keyword">size_t</span> i = <span class="number">1</span>; i &lt; args.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!expand_props(args[i], &amp;expanded_args[i])) &#123;</span><br><span class="line">            LOG(FATAL) &lt;&lt; args[<span class="number">0</span>] &lt;&lt; <span class="string">": cannot expand '"</span> &lt;&lt; args[i] &lt;&lt; <span class="string">"'"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        c_strings.push_back(expanded_args[i].data());</span><br><span class="line">    &#125;</span><br><span class="line">    c_strings.push_back(<span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最终通过execv执行程序</span></span><br><span class="line">    <span class="keyword">return</span> execv(c_strings[<span class="number">0</span>], c_strings.data()) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4.在Start()函数中，如果Service已经运行，则不再启动。如果没有，则使用fork()函数创建子进程，并返回pid值。当pid为0时，则说明当前代码逻辑在子进程中运行，最然后会调用execv()函数去启动子进程，并进入该Service的main函数中，如果该Service是Zygote，则会执行Zygote的main函数。</p>
<h5 id="app-process-app-main-cpp-main"><a href="#app-process-app-main-cpp-main" class="headerlink" title="app_process/app_main.cpp.main"></a>app_process/app_main.cpp.main</h5><p>Zygote 进程入口函数在<code>frameworks/base/cmds/app_process/app_main.cpp</code>，它的 main 方法如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  	...</span><br><span class="line">    <span class="comment">//创建了AppRuntime对象，AppRuntime类继承自AndroidRuntime</span></span><br><span class="line">    <span class="function">AppRuntime <span class="title">runtime</span><span class="params">(argv[<span class="number">0</span>], computeArgBlockSize(argc, argv))</span></span>;</span><br><span class="line">    <span class="comment">// Process command line arguments</span></span><br><span class="line">    <span class="comment">// ignore argv[0]</span></span><br><span class="line">    argc--;</span><br><span class="line">    argv++;</span><br><span class="line">    <span class="comment">//从命令行参数中找到虚拟机相关的参数，添加到runtime对象</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* spaced_commands[] = &#123; <span class="string">"-cp"</span>, <span class="string">"-classpath"</span> &#125;;</span><br><span class="line">    <span class="comment">// Allow "spaced commands" to be succeeded by exactly 1 argument (regardless of -s).</span></span><br><span class="line">    <span class="keyword">bool</span> known_command = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (known_command == <span class="literal">true</span>) &#123;</span><br><span class="line">          runtime.addOption(strdup(argv[i]));</span><br><span class="line">          <span class="comment">// The static analyzer gets upset that we don't ever free the above</span></span><br><span class="line">          <span class="comment">// string. Since the allocation is from main, leaking it doesn't seem</span></span><br><span class="line">          <span class="comment">// problematic. NOLINTNEXTLINE</span></span><br><span class="line">          ALOGV(<span class="string">"app_process main add known option '%s'"</span>, argv[i]);</span><br><span class="line">          known_command = <span class="literal">false</span>;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">             j &lt; <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(<span class="keyword">sizeof</span>(spaced_commands) / <span class="keyword">sizeof</span>(spaced_commands[<span class="number">0</span>]));</span><br><span class="line">             ++j) &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], spaced_commands[j]) == <span class="number">0</span>) &#123;</span><br><span class="line">            known_command = <span class="literal">true</span>;</span><br><span class="line">            ALOGV(<span class="string">"app_process main found known command '%s'"</span>, argv[i]);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (argv[i][<span class="number">0</span>] != <span class="string">'-'</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (argv[i][<span class="number">1</span>] == <span class="string">'-'</span> &amp;&amp; argv[i][<span class="number">2</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">            ++i; <span class="comment">// Skip --.</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        runtime.addOption(strdup(argv[i]));</span><br><span class="line">        <span class="comment">// The static analyzer gets upset that we don't ever free the above</span></span><br><span class="line">        <span class="comment">// string. Since the allocation is from main, leaking it doesn't seem</span></span><br><span class="line">        <span class="comment">// problematic. NOLINTNEXTLINE</span></span><br><span class="line">        ALOGV(<span class="string">"app_process main add option '%s'"</span>, argv[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Parse runtime arguments.  Stop at first unrecognized option.</span></span><br><span class="line">    <span class="comment">// 解析runtime参数</span></span><br><span class="line">    <span class="keyword">bool</span> zygote = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> startSystemServer = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> application = <span class="literal">false</span>;</span><br><span class="line">    String8 niceName;</span><br><span class="line">    String8 className;</span><br><span class="line"></span><br><span class="line">    ++i;  <span class="comment">// Skip unused "parent dir" argument.</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt; argc) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* arg = argv[i++];</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--zygote"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            zygote = <span class="literal">true</span>;</span><br><span class="line">            niceName = ZYGOTE_NICE_NAME;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--start-system-server"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            startSystemServer = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--application"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            application = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">"--nice-name="</span>, <span class="number">12</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            niceName.setTo(arg + <span class="number">12</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">"--"</span>, <span class="number">2</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            className.setTo(arg);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            --i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//准备启动ZygoteInit类或者RuntimeInit类，根据类名是否存在为空，来区别是非zyoget模式和zyoget模式.</span></span><br><span class="line">    Vector&lt;String8&gt; args;</span><br><span class="line">    <span class="keyword">if</span> (!className.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// We're not in zygote mode, the only argument we need to pass</span></span><br><span class="line">        <span class="comment">// to RuntimeInit is the application argument.</span></span><br><span class="line">        <span class="comment">// The Remainder of args get passed to startup class main(). Make</span></span><br><span class="line">        <span class="comment">// copies of them before we overwrite them with the process name.</span></span><br><span class="line">        args.add(application ? String8(<span class="string">"application"</span>) : String8(<span class="string">"tool"</span>));</span><br><span class="line">        runtime.setClassNameAndArgs(className, argc - i, argv + i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!LOG_NDEBUG) &#123;</span><br><span class="line">          String8 restOfArgs;</span><br><span class="line">          <span class="keyword">char</span>* <span class="keyword">const</span>* argv_new = argv + i;</span><br><span class="line">          <span class="keyword">int</span> argc_new = argc - i;</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; argc_new; ++k) &#123;</span><br><span class="line">            restOfArgs.append(<span class="string">"\""</span>);</span><br><span class="line">            restOfArgs.append(argv_new[k]);</span><br><span class="line">            restOfArgs.append(<span class="string">"\" "</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          ALOGV(<span class="string">"Class name = %s, args = %s"</span>, className.<span class="built_in">string</span>(), restOfArgs.<span class="built_in">string</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// We're in zygote mode.</span></span><br><span class="line">        maybeCreateDalvikCache();</span><br><span class="line">        <span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">            args.add(String8(<span class="string">"start-system-server"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">char</span> prop[PROP_VALUE_MAX];</span><br><span class="line">        <span class="keyword">if</span> (property_get(ABI_LIST_PROPERTY, prop, <span class="literal">NULL</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_ALWAYS_FATAL(<span class="string">"app_process: Unable to determine ABI list from property %s."</span>,</span><br><span class="line">                ABI_LIST_PROPERTY);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">String8 <span class="title">abiFlag</span><span class="params">(<span class="string">"--abi-list="</span>)</span></span>;</span><br><span class="line">        abiFlag.append(prop);</span><br><span class="line">        args.add(abiFlag);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// In zygote mode, pass all remaining arguments to the zygote</span></span><br><span class="line">        <span class="comment">// main() method.</span></span><br><span class="line">        <span class="keyword">for</span> (; i &lt; argc; ++i) &#123;</span><br><span class="line">            args.add(String8(argv[i]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果niceName不为空，则将本进程的名称修改为参数** --nice-name** 指定的字符串。缺省的情况下，niceName 的值为"zygote"或者"zygote64"</span></span><br><span class="line">  	<span class="keyword">if</span> (!niceName.isEmpty()) &#123;</span><br><span class="line">    	runtime.setArgv0(niceName.<span class="built_in">string</span>(), <span class="literal">true</span> <span class="comment">/* setProcName */</span>);</span><br><span class="line">  	&#125;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// 调用 AppRuntime 父类 AndroidRuntime 的 start 方法创建 zygote 进程</span></span><br><span class="line">    <span class="keyword">if</span> (zygote) &#123;</span><br><span class="line">        <span class="comment">//zygote 模式，即启动ZygoteInit.java </span></span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.ZygoteInit"</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className) &#123;</span><br><span class="line">       <span class="comment">//非zygote 模式，即启动RuntimeInit.java</span></span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.RuntimeInit"</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error: no class name or --zygote supplied.\n"</span>);</span><br><span class="line">        app_usage();</span><br><span class="line">        LOG_ALWAYS_FATAL(<span class="string">"app_process: no class name or --zygote supplied."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5.调用runtime.start()方法初始化Android运行环境并进入ZygoteInit的main方法进入Java层。AppRuntime继承自AndroidRuntime类，并且重载了onVmCreated 、onStarted、onZygoteInit和onExit函数。我们发现并没有重载start函数，而在app_main.cpp的main()函数的最后runtime.start函数，所以具体执行在AndroidRuntime类的start函数。</p>
<blockquote>
<p>AndroidRuntime类是安卓底层系统超级重要的一个类，它负责启动虚拟机以及Java线程。AndroidRuntime类是在一个进程中只有一个实例对象，并将其保存在全局变量gCurRuntime中。</p>
</blockquote>
<h5 id="AndroidRuntime-cpp-start"><a href="#AndroidRuntime-cpp-start" class="headerlink" title="AndroidRuntime.cpp.start"></a>AndroidRuntime.cpp.start</h5><p>AndroidRuntime 类<code>frameworks/base/core/jni/AndroidRuntime.cpp</code> 的 start 方法：</p>
<p>该方法注释说明：</p>
<blockquote>
<p>启动Android运行时环境，包括启动虚拟机并调用以”className”命名的类的静态main()方法。<br>这个mian方法的两个入参一个是类名，一个是特定选项的字符串</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Start the Android runtime.  This involves starting the virtual machine</span></span><br><span class="line"><span class="comment"> * and calling the "static void main(String[] args)" method in the class</span></span><br><span class="line"><span class="comment"> * named by "className".</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AndroidRuntime::start</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* className, <span class="keyword">const</span> Vector&lt;String8&gt;&amp; options, <span class="keyword">bool</span> zygote)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  	...</span><br><span class="line">      </span><br><span class="line">   <span class="comment">//获取系统目录</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* rootDir = getenv(<span class="string">"ANDROID_ROOT"</span>);</span><br><span class="line">    <span class="keyword">if</span> (rootDir == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        rootDir = <span class="string">"/system"</span>;</span><br><span class="line">        <span class="keyword">if</span> (!hasDir(<span class="string">"/system"</span>)) &#123;</span><br><span class="line">            LOG_FATAL(<span class="string">"No root directory specified, and /system does not exist."</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        setenv(<span class="string">"ANDROID_ROOT"</span>, rootDir, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* runtimeRootDir = getenv(<span class="string">"ANDROID_RUNTIME_ROOT"</span>);</span><br><span class="line">    <span class="keyword">if</span> (runtimeRootDir == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_FATAL(<span class="string">"No runtime directory specified with ANDROID_RUNTIME_ROOT environment variable."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* tzdataRootDir = getenv(<span class="string">"ANDROID_TZDATA_ROOT"</span>);</span><br><span class="line">    <span class="keyword">if</span> (tzdataRootDir == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_FATAL(<span class="string">"No tz data directory specified with ANDROID_TZDATA_ROOT environment variable."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//const char* kernelHack = getenv("LD_ASSUME_KERNEL");</span></span><br><span class="line">    <span class="comment">//ALOGD("Found LD_ASSUME_KERNEL='%s'\n", kernelHack);</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* start the virtual machine */</span></span><br><span class="line">    JniInvocation jni_invocation;</span><br><span class="line">    <span class="comment">//完成jni接口的初始化</span></span><br><span class="line">    jni_invocation.Init(<span class="literal">NULL</span>);</span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    <span class="comment">//启动虚拟机</span></span><br><span class="line">    <span class="keyword">if</span> (startVm(&amp;mJavaVM, &amp;env, zygote) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">//调用继承类的AppRuntime中的重载函数</span></span><br><span class="line">   <span class="comment">//如果是Zygote的启动，则onVmCreated实际上什么也不做，如果是非Zygote模式，则根据类名获取类，并释放了类名</span></span><br><span class="line">    onVmCreated(env);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Register android functions.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">   <span class="comment">//注册系统的JNI函数</span></span><br><span class="line">    <span class="keyword">if</span> (startReg(env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Unable to register all android natives\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * We want to call main() with a String array with arguments in it.</span></span><br><span class="line"><span class="comment">     * At present we have two arguments, the class name and an option string.</span></span><br><span class="line"><span class="comment">     * Create an array to hold them.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">   <span class="comment">//为启动Java类的main函数做准备</span></span><br><span class="line">    jclass stringClass;</span><br><span class="line">    jobjectArray strArray;</span><br><span class="line">    jstring classNameStr;</span><br><span class="line"></span><br><span class="line">    stringClass = env-&gt;FindClass(<span class="string">"java/lang/String"</span>);</span><br><span class="line">    assert(stringClass != <span class="literal">NULL</span>);</span><br><span class="line">    strArray = env-&gt;NewObjectArray(options.<span class="built_in">size</span>() + <span class="number">1</span>, stringClass, <span class="literal">NULL</span>);</span><br><span class="line">    assert(strArray != <span class="literal">NULL</span>);</span><br><span class="line">    classNameStr = env-&gt;NewStringUTF(className);</span><br><span class="line">    assert(classNameStr != <span class="literal">NULL</span>);</span><br><span class="line">    env-&gt;SetObjectArrayElement(strArray, <span class="number">0</span>, classNameStr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; options.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">        jstring optionsStr = env-&gt;NewStringUTF(options.itemAt(i).<span class="built_in">string</span>());</span><br><span class="line">        assert(optionsStr != <span class="literal">NULL</span>);</span><br><span class="line">        env-&gt;SetObjectArrayElement(strArray, i + <span class="number">1</span>, optionsStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Start VM.  This thread becomes the main thread of the VM, and will</span></span><br><span class="line"><span class="comment">     * not return until the VM exits.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//调用Zygoteinit类或RuntimeInit类的main()函数</span></span><br><span class="line">    <span class="keyword">char</span>* slashClassName = toSlashClassName(className != <span class="literal">NULL</span> ? className : <span class="string">""</span>);</span><br><span class="line">    jclass startClass = env-&gt;FindClass(slashClassName);</span><br><span class="line">    <span class="keyword">if</span> (startClass == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"JavaVM unable to locate class '%s'\n"</span>, slashClassName);</span><br><span class="line">        <span class="comment">/* keep going */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 找到 ZygoteInit/RuntimeInit 的 main 函数</span></span><br><span class="line">        jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, <span class="string">"main"</span>,</span><br><span class="line">            <span class="string">"([Ljava/lang/String;)V"</span>);</span><br><span class="line">        <span class="keyword">if</span> (startMeth == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">"JavaVM unable to find main() in '%s'\n"</span>, className);</span><br><span class="line">            <span class="comment">/* keep going */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 通过 JNI 调用 ZygoteInit/RuntimeInit 的 main 函数</span></span><br><span class="line">            env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">            <span class="keyword">if</span> (env-&gt;ExceptionCheck())</span><br><span class="line">                threadExitUncaughtException(env);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(slashClassName);</span><br><span class="line"></span><br><span class="line">    ALOGD(<span class="string">"Shutting down VM\n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DetachCurrentThread() != JNI_OK)</span><br><span class="line">        ALOGW(<span class="string">"Warning: unable to detach main thread\n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DestroyJavaVM() != <span class="number">0</span>)</span><br><span class="line">        ALOGW(<span class="string">"Warning: VM did not shut down cleanly\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AndroidRuntime 类的 start 方法：</p>
<ol>
<li><code>startVm()</code>，创建虚拟机</li>
<li><code>startReg()</code>，注册JNI方法</li>
<li><code>env-&gt;CallStaticVoidMethod()</code>，调用 Java 层指定的class的静态main方法</li>
</ol>
<p>至此，总结一下 Zygote 进程启动过程：</p>
<ol>
<li>由init进程解析<code>init.rc</code>文件，通过解析命令调用<code>Service.cpp.Start()</code>fork出Zygote进程，最后执行execv()调用进入Zygote的main方法<code>app_process/app_main.cpp.main()</code></li>
<li>调用<code>AndroidRuntime.start()</code>方法开始创建Android运行时环境</li>
<li>调用<code>AndroidRuntime.startVM()</code>方法初始化创建和启动Dalvik虚拟机</li>
<li>调用<code>AndroidRuntime.startReg()</code>为DVM注册系统JNI方法</li>
<li>调用 JNI方法<code>CallStaticVoidMethod()</code> 反射调用ZygoteInit类静态main()方法执行Zygote进程，第一次进入Java的世界</li>
</ol>
<h5 id="ZygoteInit-main"><a href="#ZygoteInit-main" class="headerlink" title="ZygoteInit.main"></a>ZygoteInit.main</h5><p>通过 JNI 的方式进入Java FrameWork层<code>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</code> 的main方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</span><br><span class="line">        ZygoteServer zygoteServer = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Mark zygote start. This ensures that thread creation will throw</span></span><br><span class="line">        <span class="comment">// an error.</span></span><br><span class="line">        <span class="comment">//这里其实只是设置一个标志位，为创建Java线程时做判断处理，如果是zygote进程，则不需要开启线程</span></span><br><span class="line">        ZygoteHooks.startZygoteNoThreadCreation();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Zygote goes into its own process group.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//设置进程组ID</span></span><br><span class="line">            Os.setpgid(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to setpgid(0,0)"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Runnable caller;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Report Zygote start time to tron unless it is a runtime restart</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="string">"1"</span>.equals(SystemProperties.get(<span class="string">"sys.boot_completed"</span>))) &#123;</span><br><span class="line">                MetricsLogger.histogram(<span class="keyword">null</span>, <span class="string">"boot_zygote_init"</span>,</span><br><span class="line">                        (<span class="keyword">int</span>) SystemClock.elapsedRealtime());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//判断当前进程是64位程序还是32位程序，并设置标记</span></span><br><span class="line">            String bootTimeTag = Process.is64Bit() ? <span class="string">"Zygote64Timing"</span> : <span class="string">"Zygote32Timing"</span>;</span><br><span class="line">            TimingsTraceLog bootTimingsTraceLog = <span class="keyword">new</span> TimingsTraceLog(bootTimeTag,</span><br><span class="line">                    Trace.TRACE_TAG_DALVIK);</span><br><span class="line">            bootTimingsTraceLog.traceBegin(<span class="string">"ZygoteInit"</span>);</span><br><span class="line">            RuntimeInit.enableDdms();<span class="comment">// 启用 DDMS</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> startSystemServer = <span class="keyword">false</span>;</span><br><span class="line">            String zygoteSocketName = <span class="string">"zygote"</span>;</span><br><span class="line">            String abiList = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">boolean</span> enableLazyPreload = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; argv.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"start-system-server"</span>.equals(argv[i])) &#123;</span><br><span class="line">                    startSystemServer = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"--enable-lazy-preload"</span>.equals(argv[i])) &#123;</span><br><span class="line">                    enableLazyPreload = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(ABI_LIST_ARG)) &#123;</span><br><span class="line">                    abiList = argv[i].substring(ABI_LIST_ARG.length());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;</span><br><span class="line">                    zygoteSocketName = argv[i].substring(SOCKET_NAME_ARG.length());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unknown command line argument: "</span> + argv[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> isPrimaryZygote = zygoteSocketName.equals(Zygote.PRIMARY_SOCKET_NAME);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (abiList == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No ABI list supplied."</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// In some configurations, we avoid preloading resources and classes eagerly.</span></span><br><span class="line">            <span class="comment">// In such cases, we will preload things prior to our first fork.</span></span><br><span class="line">            <span class="keyword">if</span> (!enableLazyPreload) &#123;</span><br><span class="line">                bootTimingsTraceLog.traceBegin(<span class="string">"ZygotePreload"</span>);</span><br><span class="line">                EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START,</span><br><span class="line">                        SystemClock.uptimeMillis());</span><br><span class="line">                preload(bootTimingsTraceLog);</span><br><span class="line">                EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END,</span><br><span class="line">                        SystemClock.uptimeMillis());</span><br><span class="line">                bootTimingsTraceLog.traceEnd(); <span class="comment">// ZygotePreload</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Zygote.resetNicePriority();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Do an initial gc to clean up after startup</span></span><br><span class="line">            bootTimingsTraceLog.traceBegin(<span class="string">"PostZygoteInitGC"</span>);</span><br><span class="line">            gcAndFinalize();<span class="comment">//调用ZygoteHooks.gcAndFinalize()进行垃圾回收</span></span><br><span class="line">            bootTimingsTraceLog.traceEnd(); <span class="comment">// PostZygoteInitGC</span></span><br><span class="line"></span><br><span class="line">            bootTimingsTraceLog.traceEnd(); <span class="comment">// ZygoteInit</span></span><br><span class="line">            <span class="comment">// Disable tracing so that forked processes do not inherit stale tracing tags from</span></span><br><span class="line">            <span class="comment">// Zygote.</span></span><br><span class="line">            Trace.setTracingEnabled(<span class="keyword">false</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            Zygote.initNativeState(isPrimaryZygote);</span><br><span class="line"></span><br><span class="line">            ZygoteHooks.stopZygoteNoThreadCreation();</span><br><span class="line">            <span class="comment">//创建zygoteServer，为其他进程初始化创建时与mZygoteSocket通信做准备</span></span><br><span class="line">            zygoteServer = <span class="keyword">new</span> ZygoteServer(isPrimaryZygote);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">              <span class="comment">//启动SystemServer进程，通过fork的方式开启zygote的子进程systemServer，并返回一个Runnale对象</span></span><br><span class="line">                Runnable r = forkSystemServer(abiList, zygoteSocketName, zygoteServer);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// &#123;@code r == null&#125; in the parent (zygote) process, and &#123;@code r != null&#125; in the child (system_server) process.</span></span><br><span class="line">                <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r.run();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Log.i(TAG, <span class="string">"Accepting command socket connections"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// The select loop returns early in the child process after a fork and</span></span><br><span class="line">            <span class="comment">// loops forever in the zygote.</span></span><br><span class="line">           <span class="comment">//循环等待处理客户端请求，来获取子进程发送的消息</span></span><br><span class="line">            caller = zygoteServer.runSelectLoop(abiList);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"System zygote died with exception"</span>, ex);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (zygoteServer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                zygoteServer.closeServerSocket();<span class="comment">// 关闭并释放 socket 连接</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We're in the child process and have exited the select loop. Proceed to execute the</span></span><br><span class="line">        <span class="comment">// command.</span></span><br><span class="line">        <span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</span><br><span class="line">            caller.run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p> Zygote 进程执行过程，调用ZygoteInit.main()方法：</p>
<ol>
<li>解析调用参数argv，初始化startSystemServer、zygoteSocketName等变量</li>
<li>调用<code>ZygoteInit.preload()</code>，进行一些系统类、资源、共享库的预加载工作，以提升运行时效率</li>
<li>调用<code>ZygoteInit.gcAndFinalize()</code>，在 forkSystemServer 之前主动进行一次GC操作</li>
<li>调用ZygoteServer构造方法，创建zygoteServer对象，用来管理和子进程通信的socket服务端，内部会创建和子进程通信的mZygoteSocket对象</li>
<li>调用<code>ZygoteInit.forkSystemServer()</code>， fork 出 SystemServer 系统服务进程</li>
<li>调用<code>ZygoteServer.runSelectLoop()</code>，循环等待处理客户端发送的创建新的应用进程请求</li>
</ol>
<h5 id="ZygoteInit-preload"><a href="#ZygoteInit-preload" class="headerlink" title="ZygoteInit.preload"></a>ZygoteInit.preload</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&gt; ZygoteInit.java</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">preload</span><span class="params">(TimingsTraceLog bootTimingsTraceLog)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        preloadClasses(); <span class="comment">// 预加载并初始化 /system/etc/preloaded-classes 中的类</span></span><br><span class="line">        ......</span><br><span class="line">        preloadResources(); <span class="comment">// 预加载系统资源</span></span><br><span class="line">        ......</span><br><span class="line">        nativePreloadAppProcessHALs(); <span class="comment">// HAL</span></span><br><span class="line">        ......</span><br><span class="line">        preloadOpenGL(); <span class="comment">// 预加载 OpenGL</span></span><br><span class="line">        ......</span><br><span class="line">        preloadSharedLibraries(); <span class="comment">// 预加载 共享库，包括 android、compiler_rt、jnigraphics 这三个库</span></span><br><span class="line">        preloadTextResources(); <span class="comment">// 预加载文字资源</span></span><br><span class="line">        <span class="comment">// Ask the WebViewFactory to do any initialization that must run in the zygote process,</span></span><br><span class="line">        <span class="comment">// for memory sharing purposes.</span></span><br><span class="line">        <span class="comment">// WebViewFactory 中一些必须在 zygote 进程中进行的初始化工作，用于共享内存</span></span><br><span class="line">        WebViewFactory.prepareWebViewInZygote();</span><br><span class="line">        warmUpJcaProviders();</span><br><span class="line"></span><br><span class="line">        sPreloadComplete = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="ZygoteInit-gcAndFinalize"><a href="#ZygoteInit-gcAndFinalize" class="headerlink" title="ZygoteInit.gcAndFinalize"></a>ZygoteInit.gcAndFinalize</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; ZygoteInit.java</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">gcAndFinalize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ZygoteHooks.gcAndFinalize();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt; ZygoteHooks.java</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">gcAndFinalize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> VMRuntime runtime = VMRuntime.getRuntime();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* runFinalizationSync() lets finalizers be called in Zygote,</span></span><br><span class="line"><span class="comment">         * which doesn't have a HeapWorker thread.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        System.gc();</span><br><span class="line">        runtime.runFinalizationSync();</span><br><span class="line">        System.gc();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="ZygoteInit-zygoteServer"><a href="#ZygoteInit-zygoteServer" class="headerlink" title="ZygoteInit.zygoteServer"></a>ZygoteInit.zygoteServer</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">zygoteServer = <span class="keyword">new</span> ZygoteServer(isPrimaryZygote);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>ZygoteServer</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZygoteServer</span> </span>&#123;   </span><br><span class="line">  ...</span><br><span class="line">    </span><br><span class="line">  ZygoteServer(<span class="keyword">boolean</span> isPrimaryZygote) &#123;</span><br><span class="line">        mUsapPoolEventFD = Zygote.getUsapPoolEventFD();</span><br><span class="line">        <span class="keyword">if</span> (isPrimaryZygote) &#123;</span><br><span class="line">            mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.PRIMARY_SOCKET_NAME);</span><br><span class="line">            mUsapPoolSocket =</span><br><span class="line">                    Zygote.createManagedSocketFromInitSocket(</span><br><span class="line">                            Zygote.USAP_POOL_PRIMARY_SOCKET_NAME);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.SECONDARY_SOCKET_NAME);</span><br><span class="line">            mUsapPoolSocket =</span><br><span class="line">                    Zygote.createManagedSocketFromInitSocket(</span><br><span class="line">                            Zygote.USAP_POOL_SECONDARY_SOCKET_NAME);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fetchUsapPoolPolicyProps();</span><br><span class="line">        mUsapPoolSupported = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ZygoteInit-forkSystemServer"><a href="#ZygoteInit-forkSystemServer" class="headerlink" title="ZygoteInit.forkSystemServer"></a>ZygoteInit.forkSystemServer</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//准备参数并 fork 系统进程</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Runnable <span class="title">forkSystemServer</span><span class="params">(String abiList, String socketName,</span></span></span><br><span class="line"><span class="function"><span class="params">            ZygoteServer zygoteServer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> capabilities = posixCapabilitiesAsBits(</span><br><span class="line">                OsConstants.CAP_IPC_LOCK,</span><br><span class="line">                ...</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">/* Containers run without some capabilities, so drop any caps that are not available. */</span></span><br><span class="line">        StructCapUserHeader header = <span class="keyword">new</span> StructCapUserHeader(</span><br><span class="line">                OsConstants._LINUX_CAPABILITY_VERSION_3, <span class="number">0</span>);</span><br><span class="line">        StructCapUserData[] data;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            data = Os.capget(header);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to capget()"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        capabilities &amp;= ((<span class="keyword">long</span>) data[<span class="number">0</span>].effective) | (((<span class="keyword">long</span>) data[<span class="number">1</span>].effective) &lt;&lt; <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Hardcoded command line to start the system server */</span></span><br><span class="line">        <span class="comment">// 启动参数</span></span><br><span class="line">        String args[] = &#123;</span><br><span class="line">                <span class="string">"--setuid=1000"</span>,</span><br><span class="line">                <span class="string">"--setgid=1000"</span>,</span><br><span class="line">                <span class="string">"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,"</span></span><br><span class="line">                        + <span class="string">"1024,1032,1065,3001,3002,3003,3006,3007,3009,3010"</span>,</span><br><span class="line">                <span class="string">"--capabilities="</span> + capabilities + <span class="string">","</span> + capabilities,</span><br><span class="line">                <span class="string">"--nice-name=system_server"</span>,<span class="comment">// 进程名</span></span><br><span class="line">                <span class="string">"--runtime-args"</span>,</span><br><span class="line">                <span class="string">"--target-sdk-version="</span> + VMRuntime.SDK_VERSION_CUR_DEVELOPMENT,</span><br><span class="line">                <span class="string">"com.android.server.SystemServer"</span>,<span class="comment">// 加载类名</span></span><br><span class="line">        &#125;;</span><br><span class="line">        ZygoteArguments parsedArgs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> pid;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            parsedArgs = <span class="keyword">new</span> ZygoteArguments(args);</span><br><span class="line">            Zygote.applyDebuggerSystemProperty(parsedArgs);</span><br><span class="line">            Zygote.applyInvokeWithSystemProperty(parsedArgs);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> profileSystemServer = SystemProperties.getBoolean(</span><br><span class="line">                    <span class="string">"dalvik.vm.profilesystemserver"</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (profileSystemServer) &#123;</span><br><span class="line">                parsedArgs.mRuntimeFlags |= Zygote.PROFILE_SYSTEM_SERVER;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Request to fork the system server process */</span></span><br><span class="line">            <span class="comment">//fork system_server 进程</span></span><br><span class="line">            pid = Zygote.forkSystemServer(</span><br><span class="line">                    parsedArgs.mUid, parsedArgs.mGid,</span><br><span class="line">                    parsedArgs.mGids,</span><br><span class="line">                    parsedArgs.mRuntimeFlags,</span><br><span class="line">                    <span class="keyword">null</span>,</span><br><span class="line">                    parsedArgs.mPermittedCapabilities,</span><br><span class="line">                    parsedArgs.mEffectiveCapabilities);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* For child process */</span></span><br><span class="line">        <span class="comment">//pid == 0 表示子进程即system_server进程，继续剩余工作</span></span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hasSecondZygote(abiList)) &#123;</span><br><span class="line">               <span class="comment">// 如果有第二个 Zygote，需要等待2个zygote创建完成</span></span><br><span class="line">                waitForSecondaryZygote(socketName);</span><br><span class="line">            &#125;</span><br><span class="line">            zygoteServer.closeServerSocket(); <span class="comment">// 关闭并释放从 Zygote 复制过来的 socket</span></span><br><span class="line">            <span class="keyword">return</span> handleSystemServerProcess(parsedArgs);<span class="comment">//完成新创建的 system_server 进程的剩余工作</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;<span class="comment">//如果是父进程就返回null</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>从上面的启动参数可以看到，<code>SystemServer</code> 进程的 <code>uid</code> 和 <code>gid</code> 都是 1000，进程名是 <strong><code>system_server</code></strong> ，其最后要加载的类名是 <strong><code>com.android.server.SystemServer</code></strong> 。准备好一系列参数之后通过 <code>ZygoteConnection.Arguments()</code>拼接，接着调用 <code>Zygote.forkSystemServer()</code> 方法，然后如果是子进程执行剩余工作，如果是父进程返回null。</p>
<p>ZygoteInit.forkSystemServer方法：</p>
<ol>
<li>为fork准备参数parsedArgs</li>
<li>调用Zygote.forkSystemServer()方法来创建system_server</li>
<li>fork之后，是子进程调用handleSystemServerProcess()方法执行system_server的剩余工作，父进程返回null</li>
</ol>
<h5 id="ZygoteServer-runSelectLoop"><a href="#ZygoteServer-runSelectLoop" class="headerlink" title="ZygoteServer.runSelectLoop"></a>ZygoteServer.runSelectLoop</h5><p>处理启动应用的请求，位于<code>frameworks/base/core/java/com/android/internal/os/ZygoteServer.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//执行zygote进程的循环。当来一个新的连接请求时，则建立接受并建立连接，并在连接中读取请求的命令</span></span><br><span class="line"><span class="function">Runnable <span class="title">runSelectLoop</span><span class="params">(String abiList)</span> </span>&#123;</span><br><span class="line">        ArrayList&lt;FileDescriptor&gt; socketFDs = <span class="keyword">new</span> ArrayList&lt;FileDescriptor&gt;();</span><br><span class="line">        ArrayList&lt;ZygoteConnection&gt; peers = <span class="keyword">new</span> ArrayList&lt;ZygoteConnection&gt;();</span><br><span class="line">        <span class="comment">//mZygoteSocket是zygote进程中的socket服务端</span></span><br><span class="line">        socketFDs.add(mZygoteSocket.getFileDescriptor());</span><br><span class="line">        peers.add(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            fetchUsapPoolPolicyPropsWithMinInterval();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span>[] usapPipeFDs = <span class="keyword">null</span>;</span><br><span class="line">            StructPollfd[] pollFDs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mUsapPoolEnabled) &#123;</span><br><span class="line">                usapPipeFDs = Zygote.getUsapPipeFDs();</span><br><span class="line">                pollFDs = <span class="keyword">new</span> StructPollfd[socketFDs.size() + <span class="number">1</span> + usapPipeFDs.length];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                pollFDs = <span class="keyword">new</span> StructPollfd[socketFDs.size()];</span><br><span class="line">            &#125;</span><br><span class="line">          </span><br><span class="line">            <span class="keyword">int</span> pollIndex = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (FileDescriptor socketFD : socketFDs) &#123;</span><br><span class="line">                pollFDs[pollIndex] = <span class="keyword">new</span> StructPollfd();</span><br><span class="line">                pollFDs[pollIndex].fd = socketFD;</span><br><span class="line">                pollFDs[pollIndex].events = (<span class="keyword">short</span>) POLLIN;</span><br><span class="line">                ++pollIndex;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> usapPoolEventFDIndex = pollIndex;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mUsapPoolEnabled) &#123;</span><br><span class="line">                pollFDs[pollIndex] = <span class="keyword">new</span> StructPollfd();</span><br><span class="line">                pollFDs[pollIndex].fd = mUsapPoolEventFD;</span><br><span class="line">                pollFDs[pollIndex].events = (<span class="keyword">short</span>) POLLIN;</span><br><span class="line">                ++pollIndex;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> usapPipeFD : usapPipeFDs) &#123;</span><br><span class="line">                    FileDescriptor managedFd = <span class="keyword">new</span> FileDescriptor();</span><br><span class="line">                    managedFd.setInt$(usapPipeFD);</span><br><span class="line"></span><br><span class="line">                    pollFDs[pollIndex] = <span class="keyword">new</span> StructPollfd();</span><br><span class="line">                    pollFDs[pollIndex].fd = managedFd;</span><br><span class="line">                    pollFDs[pollIndex].events = (<span class="keyword">short</span>) POLLIN;</span><br><span class="line">                    ++pollIndex;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// 查询轮询状态，当pollFDs有事件到来则往下执行，否则阻塞在这里</span></span><br><span class="line">                Os.poll(pollFDs, -<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"poll failed"</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> usapPoolFDRead = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (--pollIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="comment">// 采用I/O 多路复用机制，当接受到客户端发出的连接请求，或者处理事件时，则往下执行</span></span><br><span class="line">                 <span class="comment">// 否则进入continue，跳出本次循环 </span></span><br><span class="line">                <span class="keyword">if</span> ((pollFDs[pollIndex].revents &amp; POLLIN) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (pollIndex == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// Zygote server socket</span></span><br><span class="line">                    <span class="comment">// 有新客户端连接，服务端调用accept与客户端建立连接</span></span><br><span class="line">                    ZygoteConnection newPeer = acceptCommandPeer(abiList);</span><br><span class="line">                    peers.add(newPeer);</span><br><span class="line">                    socketFDs.add(newPeer.getFileDescriptor());</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pollIndex &lt; usapPoolEventFDIndex) &#123;</span><br><span class="line">                    <span class="comment">// Session socket accepted from the Zygote server socket</span></span><br><span class="line">                    <span class="comment">// 处理客户端请求</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                       <span class="comment">//获取到客户端连接对象ZygoteConnection</span></span><br><span class="line">                        ZygoteConnection connection = peers.get(pollIndex);</span><br><span class="line">                      <span class="comment">//读取一个sokcet命令，并fork出子进程，执行子进程的main函数</span></span><br><span class="line">                        <span class="keyword">final</span> Runnable command = connection.processOneCommand(<span class="keyword">this</span>);</span><br><span class="line">                        <span class="keyword">if</span> (mIsForkChild) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (command == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"command == null"</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">return</span> command;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (command != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"command != null"</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (connection.isClosedByPeer()) &#123;</span><br><span class="line">                                connection.closeSocket();</span><br><span class="line">                                peers.remove(pollIndex);</span><br><span class="line">                                socketFDs.remove(pollIndex);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    ...    </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ZygoteServer.runSelectLoop 方法：</p>
<ol>
<li>监听socket事件， <code>Os.poll(pollFDs, -1)</code>查询轮询状态，有事件执行否则阻塞</li>
<li>接受连接请求，调用<code>acceptCommandPeer</code>创建客户端连接 ZygoteConnection 对象</li>
<li>处理客户端请求，获取一个 ZygoteConnection 对象并执行其<code>processOneCommand()</code>函数，读取一个sokcet命令，并fork出子进程，执行子进程的main函数</li>
</ol>
<h5 id="ZygoteConnection-processOneCommand"><a href="#ZygoteConnection-processOneCommand" class="headerlink" title="ZygoteConnection.processOneCommand"></a>ZygoteConnection.processOneCommand</h5><p>processOneCommand() 方法调用创建子进程的方法，这里就贴一下关键部分：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//从套接字读取一个启动命令，如果成功的话，</span></span><br><span class="line"><span class="comment">//在子进程中返回调用子进程main方法的Runnable</span></span><br><span class="line"><span class="comment">//父进程则返回null。</span></span><br><span class="line"><span class="function">Runnable <span class="title">processOneCommand</span><span class="params">(ZygoteServer zygoteServer)</span> </span>&#123;</span><br><span class="line">        String args[];</span><br><span class="line">        ZygoteArguments parsedArgs = <span class="keyword">null</span>;</span><br><span class="line">        FileDescriptor[] descriptors;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            args = Zygote.readArgumentList(mSocketReader); <span class="comment">//从sokcet中读取参数</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// TODO (chriswailes): Remove this and add an assert.</span></span><br><span class="line">            descriptors = mSocket.getAncillaryFileDescriptors(); <span class="comment">//获取其附带的文件描述符</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"IOException on command socket"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">int</span> pid = -<span class="number">1</span>;</span><br><span class="line">        FileDescriptor childPipeFd = <span class="keyword">null</span>;<span class="comment">//子进程，使用管道进行进程间通信,</span></span><br><span class="line">        FileDescriptor serverPipeFd = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        parsedArgs = <span class="keyword">new</span> ZygoteArguments(args); <span class="comment">//创建Zygote参数对象</span></span><br><span class="line">        ...</span><br><span class="line">		    <span class="comment">// 分裂出新进程</span></span><br><span class="line">        pid = Zygote.forkAndSpecialize(parsedArgs.mUid, parsedArgs.mGid, parsedArgs.mGids,</span><br><span class="line">                parsedArgs.mRuntimeFlags, rlimits, parsedArgs.mMountExternal, parsedArgs.mSeInfo,</span><br><span class="line">                parsedArgs.mNiceName, fdsToClose, fdsToIgnore, parsedArgs.mStartChildZygote,</span><br><span class="line">                parsedArgs.mInstructionSet, parsedArgs.mAppDataDir, parsedArgs.mTargetSdkVersion);</span><br><span class="line">                <span class="comment">//Forks a new VM instance</span></span><br><span class="line">                <span class="comment">//创建一个新的VM实例对象，也就是我们平时说的沙盒隔离机制（sandbox）</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// in child</span></span><br><span class="line">                <span class="comment">//当pid=0则说明是新创建的子进程中执行的，</span></span><br><span class="line">                <span class="comment">//这时候ZygoteConnection类就会调用handleChildProc来启动这个子进程</span></span><br><span class="line">                zygoteServer.setForkChild();<span class="comment">//设置标志位mIsForkChild为true</span></span><br><span class="line">                ...</span><br><span class="line">                <span class="comment">//处理子进程的创建</span></span><br><span class="line">                <span class="keyword">return</span> handleChildProc(parsedArgs, descriptors, childPipeFd,</span><br><span class="line">                        parsedArgs.mStartChildZygote); </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;    </span><br><span class="line">                <span class="comment">// 父进程流程</span></span><br><span class="line">                IoUtils.closeQuietly(childPipeFd);</span><br><span class="line">                childPipeFd = <span class="keyword">null</span>;</span><br><span class="line">               <span class="comment">//处理父进程fork后清理工作，</span></span><br><span class="line">                handleParentProc(pid, descriptors, serverPipeFd);<span class="comment">//如果pid&gt;0,则为子进程设置进程号，否则就是创建失败</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            IoUtils.closeQuietly(childPipeFd);</span><br><span class="line">            IoUtils.closeQuietly(serverPipeFd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ZygoteConnection.processOneCommand 方法：</p>
<ol>
<li>为 fork 准备参数 parsedArgs</li>
<li>调用Zygote.forkAndSpecialize()方法来创建子进程</li>
<li>fork之后，是子进程调用handleChildProc()方法执行的剩余工作，父进程返回null</li>
</ol>
<p>这一块的逻辑和 <code>ZygoteInit. forkSystemServer()</code> 很相似，只是这里 fork 的是普通应用进程，调用的是 <code>forkAndSpecialize()</code> 方法。这里根据传递过来的参数创建<code>zygoteArgs</code>对象，并创建出VM虚拟机对象，最终调用<code>handleChildProc()</code>来创建子进程。</p>
<h5 id="Zygote-forkAndSpecialize"><a href="#Zygote-forkAndSpecialize" class="headerlink" title="Zygote.forkAndSpecialize"></a>Zygote.forkAndSpecialize</h5><p> fork 普通应用进程方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">forkAndSpecialize</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> gid, <span class="keyword">int</span>[] gids, <span class="keyword">int</span> runtimeFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span>[][] rlimits, <span class="keyword">int</span> mountExternal, String seInfo, String niceName, <span class="keyword">int</span>[] fdsToClose,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span>[] fdsToIgnore, <span class="keyword">boolean</span> startChildZygote, String instructionSet, String appDataDir,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> targetSdkVersion)</span> </span>&#123;</span><br><span class="line">			  <span class="comment">//在fork新进程之前，停止Zygote的4个Daemon子线程的运行      </span></span><br><span class="line">   			ZygoteHooks.preFork();</span><br><span class="line">        <span class="comment">// Resets nice priority for zygote process.</span></span><br><span class="line">        resetNicePriority();</span><br><span class="line">  			<span class="comment">//调用native方法fork子进程</span></span><br><span class="line">        <span class="keyword">int</span> pid = nativeForkAndSpecialize(</span><br><span class="line">                uid, gid, gids, runtimeFlags, rlimits, mountExternal, seInfo, niceName, fdsToClose,</span><br><span class="line">                fdsToIgnore, startChildZygote, instructionSet, appDataDir);</span><br><span class="line">        <span class="comment">// Enable tracing as soon as possible for the child process.</span></span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">            Zygote.disableExecuteOnly(targetSdkVersion);</span><br><span class="line">            Trace.setTracingEnabled(<span class="keyword">true</span>, runtimeFlags);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Note that this event ends at the end of handleChildProc,</span></span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"PostFork"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">  			<span class="comment">//fork之后启动4个Deamon子线程</span></span><br><span class="line">        ZygoteHooks.postForkCommon();</span><br><span class="line">        <span class="keyword">return</span> pid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">nativeForkAndSpecialize</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> gid, <span class="keyword">int</span>[] gids,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> runtimeFlags, <span class="keyword">int</span>[][] rlimits, <span class="keyword">int</span> mountExternal, String seInfo, String niceName,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span>[] fdsToClose, <span class="keyword">int</span>[] fdsToIgnore, <span class="keyword">boolean</span> startChildZygote, String instructionSet,</span></span></span><br><span class="line"><span class="function"><span class="params">            String appDataDir)</span></span>;</span><br></pre></td></tr></table></figure>

<p>Zygote.forkAndSpecialize方法：</p>
<ol>
<li><code>ZygoteHooks.preFork()</code>，fork 之前停止Zyote的4个Daemon子线程的运行，初始化gc堆</li>
<li>调用native层方法<code>nativeForkAndSpecialize</code> 内部会调用<code>fork()</code>方法 fork 子进程，设置新进程的主线程id，重置gc堆性能数据，设置信号处理函数等功能</li>
<li><code>ZygoteHooks.postForkCommon()</code>，fork 之后启动4个Deamon子线程</li>
</ol>
<p>Zygote.forkAndSpecialize方法执行完后，如果返回的pid等于0，表示处于子进程中，执行handleChildProc()，如果pid不等于0，则表示在zygote进程中，则调用handleParentProc()方法继续处理。</p>
<h5 id="ZygoteConnection-handleChildProc"><a href="#ZygoteConnection-handleChildProc" class="headerlink" title="ZygoteConnection.handleChildProc"></a>ZygoteConnection.handleChildProc</h5><p>handleChildProc()方法：处理子进程fork以后的初始化设置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Runnable <span class="title">handleChildProc</span><span class="params">(ZygoteArguments parsedArgs, FileDescriptor[] descriptors,</span></span></span><br><span class="line"><span class="function"><span class="params">            FileDescriptor pipeFd, <span class="keyword">boolean</span> isZygote)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">				<span class="comment">// 关闭Zygote的socket两端的连接</span></span><br><span class="line">        closeSocket();</span><br><span class="line">  			...</span><br><span class="line">        <span class="keyword">if</span> (parsedArgs.mNiceName != <span class="keyword">null</span>) &#123; <span class="comment">//判断mNiceName不为空</span></span><br><span class="line">            Process.setArgV0(parsedArgs.mNiceName); <span class="comment">//设置mNiceName为进程名</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// End of the postFork event.</span></span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">        <span class="keyword">if</span> (parsedArgs.mInvokeWith != <span class="keyword">null</span>) &#123; <span class="comment">//判断参数中mInvokeWith为空时，使用exec的系统调用开启进程</span></span><br><span class="line">           ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isZygote) &#123; <span class="comment">//非zygote模式</span></span><br><span class="line">                <span class="keyword">return</span> ZygoteInit.zygoteInit(parsedArgs.mTargetSdkVersion,</span><br><span class="line">                        parsedArgs.mRemainingArgs, <span class="keyword">null</span> <span class="comment">/* classLoader */</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">//zygote模式</span></span><br><span class="line">                <span class="keyword">return</span> ZygoteInit.childZygoteInit(parsedArgs.mTargetSdkVersion,</span><br><span class="line">                        parsedArgs.mRemainingArgs, <span class="keyword">null</span> <span class="comment">/* classLoader */</span>); <span class="comment">//zygoteInit的备选函数，同时初始化Zygote进程</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>其实这个方法内部实现很简单，就是子进程继承父进程，所以子进程里面有zygote的socket，所以首先要将其关闭，然后调用ZygoteInit.zygoteInit()方法进行相应的初始化，后面的逻辑和<code>ZygoteInit.handleSystemServerProcess()</code>方法后面逻辑类似。</p>
<h5 id="ZygoteConnection-handleParentProc"><a href="#ZygoteConnection-handleParentProc" class="headerlink" title="ZygoteConnection.handleParentProc"></a>ZygoteConnection.handleParentProc</h5><p><code>handleChildProc()</code>这一系列代码执行完毕后，会调用<code>handleParentProc()</code>对子进程创建状态进行判断，如果<code>pid&gt;0</code>则说明创建成功，到此处我们子进程以及其相关线程就准备完毕了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//处理父进程fork后的清理工作</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleParentProc</span><span class="params">(<span class="keyword">int</span> pid, FileDescriptor[] descriptors, FileDescriptor pipeFd)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            setChildPgid(pid);<span class="comment">//为子进程设置进程号</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (descriptors != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (FileDescriptor fd: descriptors) &#123;</span><br><span class="line">                IoUtils.closeQuietly(fd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> usingWrapper = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (pipeFd != <span class="keyword">null</span> &amp;&amp; pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> innerPid = -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              </span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> BYTES_REQUIRED = <span class="number">4</span>;  <span class="comment">// Bytes in an int.</span></span><br><span class="line">                StructPollfd fds[] = <span class="keyword">new</span> StructPollfd[] &#123;</span><br><span class="line">                        <span class="keyword">new</span> StructPollfd()</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">byte</span> data[] = <span class="keyword">new</span> <span class="keyword">byte</span>[BYTES_REQUIRED];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> remainingSleepTime = WRAPPED_PID_TIMEOUT_MILLIS;</span><br><span class="line">                <span class="keyword">int</span> dataIndex = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">long</span> startTime = System.nanoTime();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (dataIndex &lt; data.length &amp;&amp; remainingSleepTime &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    fds[<span class="number">0</span>].fd = pipeFd;</span><br><span class="line">                    fds[<span class="number">0</span>].events = (<span class="keyword">short</span>) POLLIN;</span><br><span class="line">                    fds[<span class="number">0</span>].revents = <span class="number">0</span>;</span><br><span class="line">                    fds[<span class="number">0</span>].userData = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">int</span> res = android.system.Os.poll(fds, remainingSleepTime);</span><br><span class="line">                    <span class="keyword">long</span> endTime = System.nanoTime();</span><br><span class="line">                    <span class="keyword">int</span> elapsedTimeMs = (<span class="keyword">int</span>)((endTime - startTime) / <span class="number">1000000l</span>);</span><br><span class="line">                    remainingSleepTime = WRAPPED_PID_TIMEOUT_MILLIS - elapsedTimeMs;</span><br><span class="line">                    ...</span><br><span class="line">                <span class="keyword">if</span> (dataIndex == data.length) &#123;</span><br><span class="line">                    DataInputStream is = <span class="keyword">new</span> DataInputStream(<span class="keyword">new</span> ByteArrayInputStream(data));</span><br><span class="line">                    innerPid = is.readInt();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">"Error reading pid from wrapped process, child may have died"</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Ensure that the pid reported by the wrapped process is either the</span></span><br><span class="line">            <span class="comment">// child process that we forked, or a descendant of it.</span></span><br><span class="line">            <span class="keyword">if</span> (innerPid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> parentPid = innerPid;</span><br><span class="line">                <span class="keyword">while</span> (parentPid &gt; <span class="number">0</span> &amp;&amp; parentPid != pid) &#123;</span><br><span class="line">                    parentPid = Process.getParentPid(parentPid);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (parentPid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    Log.i(TAG, <span class="string">"Wrapped process has pid "</span> + innerPid);</span><br><span class="line">                    pid = innerPid;</span><br><span class="line">                    usingWrapper = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Log.w(TAG, <span class="string">"Wrapped process reported a pid that is not a child of "</span></span><br><span class="line">                            + <span class="string">"the process that we forked: childPid="</span> + pid</span><br><span class="line">                            + <span class="string">" innerPid="</span> + innerPid);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="comment">// 将创建的应用进程id返回给system_server进程</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mSocketOutStream.writeInt(pid);</span><br><span class="line">            mSocketOutStream.writeBoolean(usingWrapper);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Error writing to command socket"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>至此，总结一下Zyogte进程在处理客户端请求创建普通进程消息，fork普通进程的流程：</p>
<ol>
<li>调用<code>runSelectLoop</code>，循环读取消息</li>
<li>调用<code>acceptCommandPeer()</code>接收客户端连接请求，创建客户端连接对象<code>ZygoteConnection</code></li>
<li>调用<code>ZygoteConnection.processOneCommand()</code>处理客户端请求，解析参数开始fork子进程</li>
<li>调用<code>Zygote.forkAndSpecialize()</code> fork子进程，创建虚拟机实例对象</li>
<li>调用<code>handleChildProc()</code> 处理子进程fork之后的初始化设置工作</li>
<li>调用<code>ZygoteInit.zyogteInit()</code>对子进程通用和native层的初始化，开启Binder线程池，使子进程可与其他进程通信</li>
<li>调用<code>RuntimeInit.applicationInit()</code>进行应用的初始化，</li>
<li>调用<code>RuntimeInit.findStaticMain</code>反射调用子进程静态main()方法</li>
</ol>
<h4 id="SystemServer"><a href="#SystemServer" class="headerlink" title="SystemServer"></a>SystemServer</h4><p>SystemServer是Android系统的核心之一，是Android基本服务的提供者，是Android系统运行的最基本需求，大部分Android提供的服务都运行在这个进程里。</p>
<p>Zygote通过fork后创建system_server进程，通过执行<code>ZygoteInit.forkSystemServer()</code>方法开始 fork，然后进入到<code>ZygoteInithandleSystemServerProcess()</code>方法完成fork之后的工作。</p>
<h5 id="ZygoteInit-forkSystemServer-1"><a href="#ZygoteInit-forkSystemServer-1" class="headerlink" title="ZygoteInit.forkSystemServer"></a>ZygoteInit.forkSystemServer</h5><p>在Zygote进程执行过程<code>ZygoteInit.main()</code>方法中，会调用<code>ZygoteInit.forkSystemServer()</code>开始 fork，该方法会调用<code>Zygote.forkSystemServer</code>方法。</p>
<h5 id="Zygote-forkSystemServer"><a href="#Zygote-forkSystemServer" class="headerlink" title="Zygote.forkSystemServer"></a>Zygote.forkSystemServer</h5><p>真正的 fork 出子进程 system_server。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">forkSystemServer</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> gid, <span class="keyword">int</span>[] gids, <span class="keyword">int</span> runtimeFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span>[][] rlimits, <span class="keyword">long</span> permittedCapabilities, <span class="keyword">long</span> effectiveCapabilities)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//在fork新进程之前，停止Zygote的4个Daemon子线程的运行，等待并确保Zygote的单线程(用于fork效率)</span></span><br><span class="line">  			<span class="comment">//并等待这些线程的停止，初始化gc堆的工作</span></span><br><span class="line">  			ZygoteHooks.preFork();</span><br><span class="line">       <span class="comment">// Resets nice priority for zygote process.</span></span><br><span class="line">       resetNicePriority();</span><br><span class="line">       <span class="keyword">int</span> pid = nativeForkSystemServer(</span><br><span class="line">               uid, gid, gids, runtimeFlags, rlimits,</span><br><span class="line">               permittedCapabilities, effectiveCapabilities);</span><br><span class="line">       <span class="comment">// Enable tracing as soon as we enter the system_server.</span></span><br><span class="line">       <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">           Trace.setTracingEnabled(<span class="keyword">true</span>, runtimeFlags);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//在fork新进程之后，启动Zygote的4个Deamon线程，Java堆整理，引用队列，以及析构线程。</span></span><br><span class="line">       ZygoteHooks.postForkCommon();</span><br><span class="line">       <span class="keyword">return</span> pid;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">nativeForkSystemServer</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> gid, <span class="keyword">int</span>[] gids, <span class="keyword">int</span> runtimeFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span>[][] rlimits, <span class="keyword">long</span> permittedCapabilities, <span class="keyword">long</span> effectiveCapabilities)</span></span>;</span><br></pre></td></tr></table></figure>

<p>最后的 <code>fork()</code> 操作是通过 JNI 调用 native 层方法 <code>nativeForkSystemServer()</code> 完成的。</p>
<blockquote>
<p>Zygote进程的4个Daemon子线程分别是<strong>ReferenceQueueDaemon</strong>、<strong>FinalizerDaemon</strong>、<strong>FinalizerWatchdogDaemon</strong>、<strong>HeapTaskDaemon</strong>，此处称为Zygote的4个Daemon子线程。</p>
</blockquote>
<h5 id="Zygote-nativeForkSystemServer"><a href="#Zygote-nativeForkSystemServer" class="headerlink" title="Zygote.nativeForkSystemServer"></a>Zygote.nativeForkSystemServer</h5><p>文件位于 <code>frameworks/base/core/jni/com_android_internal_os_Zygote.cpp</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jint <span class="title">com_android_internal_os_Zygote_nativeForkSystemServer</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        JNIEnv* env, jclass, <span class="keyword">uid_t</span> uid, <span class="keyword">gid_t</span> gid, jintArray gids,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint runtime_flags, jobjectArray rlimits, jlong permitted_capabilities,</span></span></span><br><span class="line"><span class="function"><span class="params">        jlong effective_capabilities)</span> </span>&#123;</span><br><span class="line">  std::vector&lt;int&gt; fds_to_close(MakeUsapPipeReadFDVector()),</span><br><span class="line">                   fds_to_ignore(fds_to_close);</span><br><span class="line"></span><br><span class="line">  fds_to_close.push_back(gUsapPoolSocketFD);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (gUsapPoolEventFD != <span class="number">-1</span>) &#123;</span><br><span class="line">    fds_to_close.push_back(gUsapPoolEventFD);</span><br><span class="line">    fds_to_ignore.push_back(gUsapPoolEventFD);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//fork 子进程</span></span><br><span class="line">  <span class="keyword">pid_t</span> pid = ForkCommon(env, <span class="literal">true</span>,</span><br><span class="line">                         fds_to_close,</span><br><span class="line">                         fds_to_ignore);</span><br><span class="line">  <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">      SpecializeCommon(env, uid, gid, gids, runtime_flags, rlimits,</span><br><span class="line">                       permitted_capabilities, effective_capabilities,</span><br><span class="line">                       MOUNT_EXTERNAL_DEFAULT, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="literal">true</span>,</span><br><span class="line">                       <span class="literal">false</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// The zygote process checks whether the child process has died or not.</span></span><br><span class="line">      ALOGI(<span class="string">"System server process %d has been created"</span>, pid);</span><br><span class="line">      gSystemServerPid = pid;</span><br><span class="line">      <span class="comment">// There is a slight window that the system server process has crashed</span></span><br><span class="line">      <span class="comment">// but it went unnoticed because we haven't published its pid yet. So</span></span><br><span class="line">      <span class="comment">// we recheck here just to make sure that all is well.</span></span><br><span class="line">      <span class="keyword">int</span> status;</span><br><span class="line">      <span class="keyword">if</span> (waitpid(pid, &amp;status, WNOHANG) == pid) &#123;</span><br><span class="line">          ALOGE(<span class="string">"System server process %d has died. Restarting Zygote!"</span>, pid);</span><br><span class="line">          RuntimeAbort(env, __LINE__, <span class="string">"System server process has died. Restarting Zygote!"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (UsePerAppMemcg()) &#123;</span><br><span class="line">          <span class="comment">// Assign system_server to the correct memory cgroup.</span></span><br><span class="line">          <span class="comment">// Not all devices mount memcg so check if it is mounted first</span></span><br><span class="line">          <span class="comment">// to avoid unnecessarily printing errors and denials in the logs.</span></span><br><span class="line">          <span class="keyword">if</span> (!SetTaskProfiles(pid, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&#123;<span class="string">"SystemMemoryProcess"</span>&#125;)) &#123;</span><br><span class="line">              ALOGE(<span class="string">"couldn't add process %d into system memcg group"</span>, pid);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Zygote.forkSystemServer方法：</p>
<ol>
<li><code>ZygoteHooks.preFork()</code>，fork 之前停止Zyote的4个Daemon子线程的运行，初始化gc堆</li>
<li>调用native层方法<code>nativeForkSystemServer()</code> 内部会调用<code>fork()</code>方法 fork 子进程，设置新进程的主线程id，重置gc堆性能数据，设置信号处理函数等功能</li>
<li><code>ZygoteHooks.postForkCommon()</code>，fork 之后启动4个Deamon子线程</li>
</ol>
<p><code>fork()</code> 函数是一次执行，两次返回。说的更严谨一点是 <strong>两个进程对一个程序的两次执行</strong>。当 <code>pid == 0</code> 时，说明现在处于子进程，当 <code>pid &gt; 0</code> 时，说明处于父进程。子进程 (system_server) 中会返回执行 <code>handleSystemServerProcess(parsedArgs)</code> 的结果，父进程 (zygote) 会返回 null。</p>
<p>回到 <code>ZygoteInit.forkSystemServer()</code> 中执行完 <code>Zygote.forkSystemServer</code> 之后的逻辑处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* For child process */</span></span><br><span class="line"><span class="comment">//pid == 0 表示子进程即system_server进程，继续剩余工作</span></span><br><span class="line"><span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line">  <span class="keyword">if</span> (hasSecondZygote(abiList)) &#123;</span><br><span class="line">    waitForSecondaryZygote(socketName);</span><br><span class="line">  &#125;</span><br><span class="line">    zygoteServer.closeServerSocket();</span><br><span class="line">   <span class="keyword">return</span> handleSystemServerProcess(parsedArgs);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//父进程 (zygote) 会返回 null</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<p>回到 <code>ZygoteInit.main()</code> 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">        Runnable r = forkSystemServer(abiList, socketName, zygoteServer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &#123;@code r == null&#125; in the parent (zygote) process, and &#123;@code r != null&#125; in the</span></span><br><span class="line">        <span class="comment">// child (system_server) process.</span></span><br><span class="line">        <span class="comment">// r == null 说明是在 zygote 进程</span></span><br><span class="line">        <span class="comment">// r != null 说明是在 system_server 进程</span></span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.run(); </span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 循环等待处理客户端请求</span></span><br><span class="line">    caller = zygoteServer.runSelectLoop(abiList);</span><br></pre></td></tr></table></figure>

<p>子进程 system_server 返回的是一个 Runnable，执行 <code>r.run()</code>，然后就直接 return 了。而父进程 zygote 返回的是 null，所以不满足 if 的判断条件，继续往下执行 <code>runSelectLoop()</code>。 </p>
<h5 id="ZygoteInit-handleSystemServerProcess"><a href="#ZygoteInit-handleSystemServerProcess" class="headerlink" title="ZygoteInit.handleSystemServerProcess"></a>ZygoteInit.handleSystemServerProcess</h5><p>子进程 (system_server) 继续完成系统服务进程的剩余工作，调用 handleSystemServerProcess 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Runnable <span class="title">handleSystemServerProcess</span><span class="params">(ZygoteArguments parsedArgs)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// set umask to 0077 so new files and directories will default to owner-only permissions.</span></span><br><span class="line">      <span class="comment">// 通过umask设置创建文件的默认权限</span></span><br><span class="line">       Os.umask(S_IRWXG | S_IRWXO);</span><br><span class="line">       <span class="comment">// 设置当前进程名为 "system_server"</span></span><br><span class="line">       <span class="keyword">if</span> (parsedArgs.mNiceName != <span class="keyword">null</span>) &#123;</span><br><span class="line">           Process.setArgV0(parsedArgs.mNiceName);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 获取环境变量SYSTEMSERVERCLASSPATH，环境变量位于init.environ.rc中</span></span><br><span class="line">       <span class="keyword">final</span> String systemServerClasspath = Os.getenv(<span class="string">"SYSTEMSERVERCLASSPATH"</span>);</span><br><span class="line">       <span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">// 对环境变量SYSTEMSERVERCLASSPATH中的jar包进行dex优化</span></span><br><span class="line">           <span class="keyword">if</span> (performSystemServerDexOpt(systemServerClasspath)) &#123;</span><br><span class="line">               sCachedSystemServerClassLoader = <span class="keyword">null</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// prevents it.</span></span><br><span class="line">           <span class="keyword">boolean</span> profileSystemServer = SystemProperties.getBoolean(</span><br><span class="line">                   <span class="string">"dalvik.vm.profilesystemserver"</span>, <span class="keyword">false</span>);</span><br><span class="line">           <span class="keyword">if</span> (profileSystemServer &amp;&amp; (Build.IS_USERDEBUG || Build.IS_ENG)) &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   prepareSystemServerProfile(systemServerClasspath);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                   Log.wtf(TAG, <span class="string">"Failed to set up system server profile"</span>, e);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//启动参数未包含"--invoke-with"，invokeWith 一般为空，直接走else</span></span><br><span class="line">       <span class="keyword">if</span> (parsedArgs.mInvokeWith != <span class="keyword">null</span>) &#123; </span><br><span class="line">           String[] args = parsedArgs.mRemainingArgs;</span><br><span class="line">           <span class="comment">// If we have a non-null system server class path, we'll have to duplicate the</span></span><br><span class="line">           <span class="comment">// existing arguments and append the classpath to it. ART will handle the classpath</span></span><br><span class="line">           <span class="comment">// correctly when we exec a new process.</span></span><br><span class="line">           <span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</span><br><span class="line">               String[] amendedArgs = <span class="keyword">new</span> String[args.length + <span class="number">2</span>];</span><br><span class="line">               amendedArgs[<span class="number">0</span>] = <span class="string">"-cp"</span>;</span><br><span class="line">               amendedArgs[<span class="number">1</span>] = systemServerClasspath;</span><br><span class="line">               System.arraycopy(args, <span class="number">0</span>, amendedArgs, <span class="number">2</span>, args.length);</span><br><span class="line">               args = amendedArgs;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           WrapperInit.execApplication(parsedArgs.mInvokeWith,</span><br><span class="line">                   parsedArgs.mNiceName, parsedArgs.mTargetSdkVersion,</span><br><span class="line">                   VMRuntime.getCurrentInstructionSet(), <span class="keyword">null</span>, args);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unexpected return from WrapperInit.execApplication"</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 创建类加载器，并赋给当前线程</span></span><br><span class="line">           createSystemServerClassLoader();</span><br><span class="line">           ClassLoader cl = sCachedSystemServerClassLoader;</span><br><span class="line">           <span class="keyword">if</span> (cl != <span class="keyword">null</span>) &#123;</span><br><span class="line">               Thread.currentThread().setContextClassLoader(cl);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">/*</span></span><br><span class="line"><span class="comment">            * Pass the remaining arguments to SystemServer.</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">           <span class="keyword">return</span> ZygoteInit.zygoteInit(parsedArgs.mTargetSdkVersion,</span><br><span class="line">                   parsedArgs.mRemainingArgs, cl);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>ZygoteInit.handleSystemServerProcess方法：</p>
<ol>
<li>设置进程名为 <code>system_server</code>，获取环境变量值，进行 dex 优化</li>
<li>创建类加载器，并设置给当前线程</li>
<li>调用 <code>ZygoteInit.zygoteInit()</code> 继续处理剩余参数</li>
</ol>
<h5 id="ZygoteInit-zygoteInit"><a href="#ZygoteInit-zygoteInit" class="headerlink" title="ZygoteInit.zygoteInit"></a>ZygoteInit.zygoteInit</h5><p><code>ZygoteInit.zygoteInit()</code> 继续处理剩余参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过zygote方法，在开启的时候，来调用main方法。</span></span><br><span class="line"><span class="comment">//如果native代码的nativeFinishInit()中通过Zygote合理的启动，将会与main()统一。  </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Runnable <span class="title">zygoteInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv,</span></span></span><br><span class="line"><span class="function"><span class="params">            ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (RuntimeInit.DEBUG) &#123;</span><br><span class="line">            Slog.d(RuntimeInit.TAG, <span class="string">"RuntimeInit: Starting application from zygote"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"ZygoteInit"</span>);</span><br><span class="line">        <span class="comment">//日志重定向 System.out 和 System.err 到 Android log</span></span><br><span class="line">        RuntimeInit.redirectLogStreams();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 一些通用初始化工作</span></span><br><span class="line">        RuntimeInit.commonInit();</span><br><span class="line">        <span class="comment">// JNI调用，native 层zygote初始化</span></span><br><span class="line">        ZygoteInit.nativeZygoteInit();</span><br><span class="line">        <span class="comment">// 调用入口函数</span></span><br><span class="line">        <span class="keyword">return</span> RuntimeInit.applicationInit(targetSdkVersion, argv, classLoader);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ZygoteInit.zygoteInit 方法：</p>
<ol>
<li><code>RuntimeInit.redirectLogStreams()</code>日志重定向</li>
<li><code>RuntimeInit.commonInit()</code>进行一些通用的初始化</li>
<li><code>ZygoteInit.nativeZygoteInit()</code> 进行 native 层 zygote 初始化，创建Binder线程池</li>
<li>调用<code>RuntimeInit.applicationInit()</code>进行应用的初始化</li>
</ol>
<h5 id="ZygoteInit-nativeZygoteInit"><a href="#ZygoteInit-nativeZygoteInit" class="headerlink" title="ZygoteInit.nativeZygoteInit"></a>ZygoteInit.nativeZygoteInit</h5><p>文件位于 <code>frameworks/base/core/jni/AndroidRuntime.cpp</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">com_android_internal_os_ZygoteInit_nativeZygoteInit</span><span class="params">(JNIEnv* env, jobject clazz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    gCurRuntime-&gt;onZygoteInit();<span class="comment">//调用AndroidRuntime的zygoteInit</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用了onZygoteInit()函数，具体实现是在AppRuntime里面，<code>AndroidRuntime</code>在<code>app_process</code>的<code>app_main</code>中有一个子类对象<code>AppRuntime</code>，位于<code>frameworks/base/cmds/app_process/app_main.cpp</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppRuntime</span> :</span> <span class="keyword">public</span> AndroidRuntime</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    AppRuntime(<span class="keyword">char</span>* argBlockStart, <span class="keyword">const</span> <span class="keyword">size_t</span> argBlockLength)</span><br><span class="line">        : AndroidRuntime(argBlockStart, argBlockLength)</span><br><span class="line">        , mClass(<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onZygoteInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">  <span class="comment">//单例模式创建ProcessState全局变量</span></span><br><span class="line">  sp&lt;ProcessState&gt; proc = ProcessState::self();</span><br><span class="line">  ALOGV(<span class="string">"App process: starting thread pool.\n"</span>);</span><br><span class="line">  proc-&gt;startThreadPool();<span class="comment">//启动新Binder线程池，设置线程名称</span></span><br><span class="line"> &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处创建了一个<code>ProcessState</code>的对象，并调用了它的<code>startThreadPool()</code>函数，跟踪下去可以发现内部调用了<code>spawnPooledThread</code>的函数来创建线程并启动的。</p>
<p><code>ProcessState.cpp</code>，位于<code>frameworks/nativ/libs/binder/ProcessState.cpp</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PoolThread</span> :</span> <span class="keyword">public</span> Thread</span><br><span class="line">&#123;</span><br><span class="line">	<span class="function">sp&lt;ProcessState&gt; <span class="title">ProcessState::self</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">    	Mutex::Autolock _l(gProcessMutex);</span><br><span class="line">    	<span class="keyword">if</span> (gProcess != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      	  <span class="keyword">return</span> gProcess;</span><br><span class="line">    	&#125;</span><br><span class="line">    	gProcess = <span class="keyword">new</span> ProcessState(<span class="string">"/dev/binder"</span>);</span><br><span class="line">    	<span class="keyword">return</span> gProcess;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ProcessState::startThreadPool</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">    	AutoMutex _l(mLock);</span><br><span class="line">    	<span class="keyword">if</span> (!mThreadPoolStarted) &#123;</span><br><span class="line">     	   mThreadPoolStarted = <span class="literal">true</span>;</span><br><span class="line">     	   spawnPooledThread(<span class="literal">true</span>);<span class="comment">//创建线程并启动</span></span><br><span class="line">   	 &#125;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//创建Binder线程池名称</span></span><br><span class="line">  <span class="function">String8 <span class="title">ProcessState::makeBinderThreadName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> s = android_atomic_add(<span class="number">1</span>, &amp;mThreadPoolSeq);</span><br><span class="line">    <span class="keyword">pid_t</span> pid = getpid();</span><br><span class="line">    String8 name;</span><br><span class="line">    name.appendFormat(<span class="string">"Binder:%d_%X"</span>, pid, s);</span><br><span class="line">    <span class="keyword">return</span> name;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">ProcessState::spawnPooledThread</span><span class="params">(<span class="keyword">bool</span> isMain)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mThreadPoolStarted) &#123;<span class="comment">//判断线程已开启</span></span><br><span class="line">        String8 name = makeBinderThreadName();<span class="comment">//创建Binder线程池名称</span></span><br><span class="line">        ALOGV(<span class="string">"Spawning new pooled thread, name=%s\n"</span>, name.<span class="built_in">string</span>());</span><br><span class="line">        sp&lt;Thread&gt; t = <span class="keyword">new</span> PoolThread(isMain);<span class="comment">//创建主线程</span></span><br><span class="line">        t-&gt;<span class="built_in">run</span>(name.<span class="built_in">string</span>());<span class="comment">//执行线程</span></span><br><span class="line">    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AppRuntime.onZygoteInit方法：</p>
<ol>
<li>构造了进程的ProcessState全局变量，主要作用就是调用open()打开<strong>/dev/binder</strong>驱动设备，再利用mmap()映射内核的地址空间，将Binder驱动的fd赋值ProcessState对象中的变量mDriverFD，用于交互操作</li>
<li>启动 Binder 线程池，创建一个新的binder，使 system_server 进程和其他进程进行Binder通信</li>
</ol>
<h5 id="RuntimeInit-applicationInit"><a href="#RuntimeInit-applicationInit" class="headerlink" title="RuntimeInit.applicationInit"></a>RuntimeInit.applicationInit</h5><p>调用<code>RuntimeInit.applicationInit</code>方法进行应用的初始化，位于<code>frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> Runnable <span class="title">applicationInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv,</span></span></span><br><span class="line"><span class="function"><span class="params">         ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// If the application calls System.exit(), terminate the process</span></span><br><span class="line">     <span class="comment">// immediately without running any shutdown hooks.  It is not possible to</span></span><br><span class="line">     <span class="comment">// shutdown an Android application gracefully.  Among other things, the</span></span><br><span class="line">     <span class="comment">// Android runtime shutdown hooks close the Binder driver, which can cause</span></span><br><span class="line">     <span class="comment">// leftover running threads to crash before the process actually exits.</span></span><br><span class="line">     <span class="comment">//true 代表应用程序退出时，不调用AppRuntime.onExit()，否则会在退出前调用</span></span><br><span class="line">     nativeSetExitWithoutCleanup(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// We want to be fairly aggressive about heap utilization, to avoid</span></span><br><span class="line">     <span class="comment">// holding on to a lot of memory that isn't needed.</span></span><br><span class="line">     <span class="comment">// 设置虚拟机的内存利用率数值为0.75</span></span><br><span class="line">     VMRuntime.getRuntime().setTargetHeapUtilization(<span class="number">0.75f</span>);</span><br><span class="line">     VMRuntime.getRuntime().setTargetSdkVersion(targetSdkVersion);</span><br><span class="line">     <span class="comment">// 解析参数</span></span><br><span class="line">     <span class="keyword">final</span> Arguments args = <span class="keyword">new</span> Arguments(argv);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// The end of of the RuntimeInit event (see #zygoteInit).</span></span><br><span class="line">     Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Remaining arguments are passed to the start class's static main</span></span><br><span class="line">    <span class="comment">//寻找 startClass 的静态main() 方法。这里的 startClass 是 com.android.server.SystemServer</span></span><br><span class="line">     <span class="keyword">return</span> findStaticMain(args.startClass, args.startArgs, classLoader);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>RuntimeInit 的 applicationInit 方法：</p>
<ol>
<li>解析调用参数</li>
<li>调用<code>findStaticMain()</code>寻找startClass类的静态main()方法</li>
</ol>
<h5 id="RuntimeInit-findStaticMain"><a href="#RuntimeInit-findStaticMain" class="headerlink" title="RuntimeInit.findStaticMain"></a>RuntimeInit.findStaticMain</h5><p>调用 <code>findStaticMain</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用目标类className类的静态main(argv []) 方法。</span></span><br><span class="line"><span class="comment">//将各种失败异常转化为RuntimeExceptions，并且这些异常将会导致VM实例退出。</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> Runnable <span class="title">findStaticMain</span><span class="params">(String className, String[] argv,</span></span></span><br><span class="line"><span class="function"><span class="params">            ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        Class&lt;?&gt; cl;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//找到指定的className类</span></span><br><span class="line">            cl = Class.forName(className, <span class="keyword">true</span>, classLoader);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Missing class when invoking static main "</span> + className,</span><br><span class="line">                    ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Method m;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//找到className类的main()方法</span></span><br><span class="line">            m = cl.getMethod(<span class="string">"main"</span>, <span class="keyword">new</span> Class[] &#123; String[]<span class="class">.<span class="keyword">class</span> &#125;)</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Missing static main on "</span> + className, ex);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Problem getting static main on "</span> + className, ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> modifiers = m.getModifiers();</span><br><span class="line">        <span class="keyword">if</span> (! (Modifier.isStatic(modifiers) &amp;&amp; Modifier.isPublic(modifiers))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Main method is not public and static on "</span> + className);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * This throw gets caught in ZygoteInit.main(), which responds</span></span><br><span class="line"><span class="comment">         * by invoking the exception's run() method. This arrangement</span></span><br><span class="line"><span class="comment">         * clears up all the stack frames that were required in setting</span></span><br><span class="line"><span class="comment">         * up the process.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">      <span class="comment">//返回一个 Runnable，在 Zygote 的 main() 方法中执行 run() 方法</span></span><br><span class="line">     <span class="comment">//之前的版本是抛出一个异常，在 main() 方法中捕获，这样做的好处是清空栈帧，提高栈帧利用率</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MethodAndArgsCaller(m, argv);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>RuntimeInit.findStaticMain方法：</p>
<ol>
<li>找到指定的className类</li>
<li>找到className类的main()方法</li>
<li>返回一个 Runnable，在 ZygoteInit 的 main() 方法中执行 run() 方法</li>
</ol>
<h5 id="MethodAndArgsCaller-run"><a href="#MethodAndArgsCaller-run" class="headerlink" title="MethodAndArgsCaller.run"></a>MethodAndArgsCaller.run</h5><p>最后调用 <code>MethodAndArgsCaller</code> 的 <code>run()</code> 方法，通过反射机制调用 SystemServer 类的 main()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodAndArgsCaller</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="comment">/** method to call */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Method mMethod;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** argument array */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String[] mArgs;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MethodAndArgsCaller</span><span class="params">(Method method, String[] args)</span> </span>&#123;</span><br><span class="line">            mMethod = method;</span><br><span class="line">            mArgs = args;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// 根据传递过来的参数，可知此处通过反射机制调用的是SystemServer.main()方法</span></span><br><span class="line">                mMethod.invoke(<span class="keyword">null</span>, <span class="keyword">new</span> Object[] &#123; mArgs &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">                Throwable cause = ex.getCause();</span><br><span class="line">                <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (RuntimeException) cause;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (Error) cause;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MethodAndArgsCaller.run方法：</p>
<ol>
<li>通过反射机制执行传递过来的参数 <code>method</code> 方法</li>
</ol>
<p>zygote启动system_server进程的流程已经一步步的简要分析完了，最后通过反射机制调用SystemServer的静态函数main方法，进行类似与初始化的工作内容了。</p>
<p>注：<strong>为什么不直接在findStaticMain()方法中直接动态调用SystemServer的main()方法呢？</strong></p>
<p>原因：是这种<strong>递归返回后再执行入口方法</strong>的方式会让SystemServer的main()方法看起来像是SystemServer的入口方法，而且，这样也会<strong>清除之前所有SystemServer相关设置过程中需要的堆栈帧</strong>。</p>
<p>至此，总结一下 SystemServer 进程启动过程：</p>
<ol>
<li>Zygote进程调用<code>ZygoteInit.forkSystemServer</code>开始fork进程</li>
<li>调用 <code>Zygote.forkSystemServer</code>fork 出SystemServer进程</li>
<li>调用<code>ZygoteInit.handleSystemServerProcess</code>处理SystemServer进程fork后的剩余工作</li>
<li>调用<code>ZygoteInit.zygoteInit()</code> 进行通用和native层的初始化，并启动Binder线程池，使system_server进程可与其他进程进程通信</li>
<li>调用<code>RuntimeInit.applicationInit</code>进行应用的初始化</li>
<li>调用<code>RuntimeInit.findStaticMain</code>反射进入SystemServer类的静态函数main()方法</li>
</ol>
<h5 id="SystemServer-main"><a href="#SystemServer-main" class="headerlink" title="SystemServer.main"></a>SystemServer.main</h5><p>SystemServer类的静态函数main方法，位于 <code>frameworks/base/services/java/com/android/server/SystemServer.java</code> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">new</span> SystemServer().run(); <span class="comment">//调用 run 方法</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">SystemServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Check for factory test mode.</span></span><br><span class="line">        mFactoryTestMode = FactoryTest.getMode();</span><br><span class="line">        <span class="comment">//记录进程开始信息</span></span><br><span class="line">        <span class="comment">// one for the password screen, second for the actual boot.</span></span><br><span class="line">        mStartCount = SystemProperties.getInt(SYSPROP_START_COUNT, <span class="number">0</span>) + <span class="number">1</span>;</span><br><span class="line">        mRuntimeStartElapsedTime = SystemClock.elapsedRealtime();</span><br><span class="line">        mRuntimeStartUptime = SystemClock.uptimeMillis();</span><br><span class="line">        mRuntimeRestart = <span class="string">"1"</span>.equals(SystemProperties.get(<span class="string">"sys.boot_completed"</span>));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>SystemServer.run</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            traceBeginAndSlog(<span class="string">"InitBeforeStartServices"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Record the process start information in sys props.</span></span><br><span class="line">           <span class="comment">//在sys props中记录进程启动信息。</span></span><br><span class="line">            SystemProperties.set(SYSPROP_START_COUNT, String.valueOf(mStartCount));</span><br><span class="line">            SystemProperties.set(SYSPROP_START_ELAPSED, String.valueOf(mRuntimeStartElapsedTime));</span><br><span class="line">            SystemProperties.set(SYSPROP_START_UPTIME, String.valueOf(mRuntimeStartUptime));</span><br><span class="line"></span><br><span class="line">            EventLog.writeEvent(EventLogTags.SYSTEM_SERVER_START,</span><br><span class="line">                    mStartCount, mRuntimeStartUptime, mRuntimeStartElapsedTime);</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 计算时间 如果当前系统时间比1970年更早，就设置当前系统时间为1970年</span></span><br><span class="line">            <span class="keyword">if</span> (System.currentTimeMillis() &lt; EARLIEST_SUPPORTED_TIME) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"System clock is before 1970; setting to 1970."</span>);</span><br><span class="line">                SystemClock.setCurrentTimeMillis(EARLIEST_SUPPORTED_TIME);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Default the timezone property to GMT if not set.</span></span><br><span class="line">            <span class="comment">//如果未设置时区属性，则将其默认为GMT。</span></span><br><span class="line">            String timezoneProperty = SystemProperties.get(<span class="string">"persist.sys.timezone"</span>);</span><br><span class="line">            <span class="keyword">if</span> (timezoneProperty == <span class="keyword">null</span> || timezoneProperty.isEmpty()) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Timezone not set; setting to GMT."</span>);</span><br><span class="line">                SystemProperties.set(<span class="string">"persist.sys.timezone"</span>, <span class="string">"GMT"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// <span class="doctag">NOTE:</span> Most changes made here will need an equivalent change to</span></span><br><span class="line">            <span class="comment">// core/jni/AndroidRuntime.cpp</span></span><br><span class="line">           <span class="comment">// 如果没有设置 语言，则设置当地的语言</span></span><br><span class="line">            <span class="keyword">if</span> (!SystemProperties.get(<span class="string">"persist.sys.language"</span>).isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">final</span> String languageTag = Locale.getDefault().toLanguageTag();</span><br><span class="line"></span><br><span class="line">                SystemProperties.set(<span class="string">"persist.sys.locale"</span>, languageTag);</span><br><span class="line">                SystemProperties.set(<span class="string">"persist.sys.language"</span>, <span class="string">""</span>);</span><br><span class="line">                SystemProperties.set(<span class="string">"persist.sys.country"</span>, <span class="string">""</span>);</span><br><span class="line">                SystemProperties.set(<span class="string">"persist.sys.localevar"</span>, <span class="string">""</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// The system server should never make non-oneway calls</span></span><br><span class="line">            <span class="comment">//设置系统服务器不应进行非单向调用</span></span><br><span class="line">            Binder.setWarnOnBlocking(<span class="keyword">true</span>);</span><br><span class="line">            <span class="comment">// The system server should always load safe labels</span></span><br><span class="line">            <span class="comment">//系统服务器应始终加载安全标签</span></span><br><span class="line">            PackageItemInfo.forceSafeLabels();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Default to FULL within the system server.</span></span><br><span class="line">            SQLiteGlobal.sDefaultSyncMode = SQLiteGlobal.SYNC_MODE_FULL;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Deactivate SQLiteCompatibilityWalFlags until settings provider is initialized</span></span><br><span class="line">           <span class="comment">//在初始化设置provider之前，停用SQLiteCompatibilityWalFlags</span></span><br><span class="line">            SQLiteCompatibilityWalFlags.init(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Here we go!</span></span><br><span class="line">            Slog.i(TAG, <span class="string">"Entered the Android system server!"</span>);</span><br><span class="line">            <span class="keyword">int</span> uptimeMillis = (<span class="keyword">int</span>) SystemClock.elapsedRealtime();</span><br><span class="line">            EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_SYSTEM_RUN, uptimeMillis);</span><br><span class="line">            <span class="keyword">if</span> (!mRuntimeRestart) &#123;</span><br><span class="line">                MetricsLogger.histogram(<span class="keyword">null</span>, <span class="string">"boot_system_server_init"</span>, uptimeMillis);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置虚拟机库文件路径，5.0以后是libart.so</span></span><br><span class="line">            SystemProperties.set(<span class="string">"persist.sys.dalvik.vm.lib.2"</span>, VMRuntime.getRuntime().vmLibrary());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Mmmmmm... more memory!</span></span><br><span class="line">            <span class="comment">// 清除VM内存增长上限，由于启动过程需要较多的虚拟机内存空间</span></span><br><span class="line">            VMRuntime.getRuntime().clearGrowthLimit();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// The system server has to run all of the time, so it needs to be</span></span><br><span class="line">            <span class="comment">// as efficient as possible with its memory usage.</span></span><br><span class="line">            <span class="comment">// 设置内存可能有效使用率为0.8</span></span><br><span class="line">            VMRuntime.getRuntime().setTargetHeapUtilization(<span class="number">0.8f</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Some devices rely on runtime fingerprint generation, so make sure</span></span><br><span class="line">            <span class="comment">// we've defined it before booting further.</span></span><br><span class="line">            <span class="comment">// 针对部分设备依赖运行时就产生指纹信息，因此需要在开机完成前已经定义</span></span><br><span class="line">            Build.ensureFingerprintProperty();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Within the system server, it is an error to access Environment paths without</span></span><br><span class="line">            <span class="comment">// explicitly specifying a user.</span></span><br><span class="line">            <span class="comment">// 设置访问环境变量的条件，即需要明确指定用户</span></span><br><span class="line">            Environment.setUserRequired(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Within the system server, any incoming Bundles should be defused</span></span><br><span class="line">            <span class="comment">// to avoid throwing BadParcelableException.</span></span><br><span class="line">            BaseBundle.setShouldDefuse(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Within the system server, when parceling exceptions, include the stack trace</span></span><br><span class="line">            Parcel.setStackTraceParceling(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Ensure binder calls into the system always run at foreground priority.</span></span><br><span class="line">           <span class="comment">//确保当前系统进程的binder调用，总是运行在前台优先级(foreground)</span></span><br><span class="line">            BinderInternal.disableBackgroundScheduling(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Increase the number of binder threads in system_server</span></span><br><span class="line">            BinderInternal.setMaxThreads(sMaxBinderThreads);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Prepare the main looper thread (this thread).</span></span><br><span class="line">            android.os.Process.setThreadPriority(</span><br><span class="line">                    android.os.Process.THREAD_PRIORITY_FOREGROUND);</span><br><span class="line">            android.os.Process.setCanSelfBackground(<span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">//创建主线程Looper，就在当前线程运行</span></span><br><span class="line">            Looper.prepareMainLooper();</span><br><span class="line">            Looper.getMainLooper().setSlowLogThresholdMs(</span><br><span class="line">                    SLOW_DISPATCH_THRESHOLD_MS, SLOW_DELIVERY_THRESHOLD_MS);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Initialize native services.</span></span><br><span class="line">            <span class="comment">// 加载“android_servers.so”库，该库包含源码在frameworks/base/services/目录下</span></span><br><span class="line">            System.loadLibrary(<span class="string">"android_servers"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Debug builds - allow heap profiling.</span></span><br><span class="line">            <span class="comment">//调试模式初始化堆分析</span></span><br><span class="line">            <span class="keyword">if</span> (Build.IS_DEBUGGABLE) &#123;</span><br><span class="line">                initZygoteChildHeapProfiling();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check whether we failed to shut down last time we tried.</span></span><br><span class="line">            <span class="comment">// This call may not return.</span></span><br><span class="line">           <span class="comment">//检查上次关键是否失败了，可能没有返回值</span></span><br><span class="line">            performPendingShutdown();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Initialize the system context.</span></span><br><span class="line">            <span class="comment">// 初始化系统上下文</span></span><br><span class="line">            createSystemContext();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create the system service manager.</span></span><br><span class="line">            <span class="comment">// 创建SystemServiceManager 用于后面的binder机制</span></span><br><span class="line">            mSystemServiceManager = <span class="keyword">new</span> SystemServiceManager(mSystemContext);</span><br><span class="line">            mSystemServiceManager.setStartInfo(mRuntimeRestart,</span><br><span class="line">                    mRuntimeStartElapsedTime, mRuntimeStartUptime);</span><br><span class="line">            <span class="comment">//添加注册到LocalServices</span></span><br><span class="line">            LocalServices.addService(SystemServiceManager<span class="class">.<span class="keyword">class</span>, <span class="title">mSystemServiceManager</span>)</span>;</span><br><span class="line">            <span class="comment">// Prepare the thread pool for init tasks that can be parallelized</span></span><br><span class="line">            <span class="comment">//为初始化任务准备线程池</span></span><br><span class="line">            SystemServerInitThreadPool.get();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            traceEnd();  <span class="comment">// InitBeforeStartServices</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start services.</span></span><br><span class="line">        <span class="comment">//启动各种系统服务</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            traceBeginAndSlog(<span class="string">"StartServices"</span>);</span><br><span class="line">            startBootstrapServices();<span class="comment">//启动引导服务AMS、PackageManagerService等 </span></span><br><span class="line">            startCoreServices();<span class="comment">// 启动核心服务BatteryService、UsageStatsService等</span></span><br><span class="line">            startOtherServices();<span class="comment">// 启动其他服务WindowManagerService、InputManagerService等</span></span><br><span class="line">            SystemServerInitThreadPool.shutdown();<span class="comment">//关闭系统服务初始化使用的线程池</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            Slog.e(<span class="string">"System"</span>, <span class="string">"******************************************"</span>);</span><br><span class="line">            Slog.e(<span class="string">"System"</span>, <span class="string">"************ Failure starting system services"</span>, ex);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            traceEnd();</span><br><span class="line">        &#125;</span><br><span class="line">        StrictMode.initVmDefaults(<span class="keyword">null</span>);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// Loop forever.</span></span><br><span class="line">        <span class="comment">// 主进程的looper开启循环处理消息</span></span><br><span class="line">        Looper.loop();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p> SystemServer 进程执行过程，调用SystemServer.main方法：</p>
<ol>
<li>调用createSystemContext()来创建ActivityThread对象和系统上下文</li>
<li>创建SystemServiceManager</li>
<li>启动各种系统服务并进行生命周期管理</li>
<li>调用Looper.loop()，进入处理消息的循环</li>
</ol>
<h5 id="SystemServer-createSystemContext"><a href="#SystemServer-createSystemContext" class="headerlink" title="SystemServer.createSystemContext"></a>SystemServer.createSystemContext</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createSystemContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">//创建system_server进程的上下文信息</span></span><br><span class="line">       ActivityThread activityThread = ActivityThread.systemMain();</span><br><span class="line">       mSystemContext = activityThread.getSystemContext();</span><br><span class="line">       mSystemContext.setTheme(DEFAULT_SYSTEM_THEME);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> Context systemUiContext = activityThread.getSystemUiContext();</span><br><span class="line">       systemUiContext.setTheme(DEFAULT_SYSTEM_THEME);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h5 id="SystemServer-startBootstrapServices"><a href="#SystemServer-startBootstrapServices" class="headerlink" title="SystemServer.startBootstrapServices"></a>SystemServer.startBootstrapServices</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBootstrapServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">  <span class="comment">// Wait for installd to finish starting up so that it has a chance to</span></span><br><span class="line">  <span class="comment">// create critical directories such as /data/user with the appropriate</span></span><br><span class="line">  <span class="comment">// permissions.  We need this to complete before we initialize other services.</span></span><br><span class="line">  Installer installer = mSystemServiceManager.startService(Installer<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  <span class="comment">// In some cases after launching an app we need to access device identifiers,</span></span><br><span class="line">  <span class="comment">// therefore register the device identifier policy before the activity manager.</span></span><br><span class="line">  mSystemServiceManager.startService(DeviceIdentifiersPolicyService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  <span class="comment">// Uri Grants Manager.</span></span><br><span class="line">  mSystemServiceManager.startService(UriGrantsManagerService.Lifecycle<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  <span class="comment">// Activity manager runs the show.</span></span><br><span class="line">  <span class="comment">// 创建启动ATMS(ActivityTaskManagerService)</span></span><br><span class="line">  <span class="comment">//是通过"ssm"反射创建"atm"的静态内部类Lifecycle对象，并通过该对象的getService()获取到"atm"实例对象</span></span><br><span class="line">  ActivityTaskManagerService atm = mSystemServiceManager.startService(</span><br><span class="line">                ActivityTaskManagerService.Lifecycle<span class="class">.<span class="keyword">class</span>).<span class="title">getService</span>()</span>;</span><br><span class="line">  <span class="comment">// 创建启动AMS(ActivityManagerService)</span></span><br><span class="line">  <span class="comment">//调用"ams"的静态内部类Lifecycle的静态方法"startService"函数，把"ssm"和"atm"传递过去</span></span><br><span class="line">  mActivityManagerService = ActivityManagerService.Lifecycle.startService(</span><br><span class="line">             mSystemServiceManager, atm);<span class="comment">//内部还是使用"ssm"来创建的"ams"</span></span><br><span class="line">  </span><br><span class="line">  mActivityManagerService.setSystemServiceManager(mSystemServiceManager);</span><br><span class="line">  mActivityManagerService.setInstaller(installer);</span><br><span class="line">  mWindowManagerGlobalLock = atm.getGlobalLock();</span><br><span class="line">  <span class="comment">// Power manager needs to be started early because other services need it.</span></span><br><span class="line">  mPowerManagerService = mSystemServiceManager.startService(PowerManagerService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ActivityManagerService是如何启动的</strong></p>
<p><code>ActivityManagerService</code>是在<code>startBootstrapServices</code>函数中开启的服务，主要涉及到了三个类，<code>ActivityTaskManagerService</code>，<code>ActivityManagerService</code>，<code>SystemServiceManager</code>，分两步：</p>
<ol>
<li>先通过<code>mSystemServiceManager.startService(class)</code>反射调用ATMS静态内部类Lifecycle的构造方法来创建ATMS对象，通过Lifecycle的<code>getService()</code>得到ATMS对象；</li>
<li>通过调用AMS的静态内部类Lifecycle方法<code>ActivityManagerService.Lifecycle.startService(ssm,atm)</code>传入mSystemServiceManager和atm对象，内部还是通过<code>mSystemServiceManager.startService(class)</code>反射调用AMS静态内部类Lifecycle的构造方法创建AMS对象，在调用<code>mSystemServiceManager.startService(service)</code>启动service时，会调用service的<code>onStart()</code>方法中，在该方法中调用AMS对象的<code>start()</code>方法。</li>
</ol>
<p>其中ATMS和AMS中有着相似的设计，都是通过静态内部类Lifecycle来创建和获取本类对象，即当前系统服务的。</p>
<h5 id="SystemServer-startCoreServices"><a href="#SystemServer-startCoreServices" class="headerlink" title="SystemServer.startCoreServices"></a>SystemServer.startCoreServices</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startCoreServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Tracks the battery level.  Requires LightService.</span></span><br><span class="line">        mSystemServiceManager.startService(BatteryService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Tracks application usage stats.</span></span><br><span class="line">        mSystemServiceManager.startService(UsageStatsService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        mActivityManagerService.setUsageStatsManager(</span><br><span class="line">                LocalServices.getService(UsageStatsManagerInternal<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">  </span><br><span class="line">        <span class="comment">// Tracks whether the updatable WebView is in a ready state and watches for update installs.</span></span><br><span class="line">        <span class="keyword">if</span> (mPackageManager.hasSystemFeature(PackageManager.FEATURE_WEBVIEW)) &#123;</span><br><span class="line">            traceBeginAndSlog(<span class="string">"StartWebViewUpdateService"</span>);</span><br><span class="line">            mWebViewUpdateService = mSystemServiceManager.startService(WebViewUpdateService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            traceEnd();</span><br><span class="line">        &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="SystemServer-startOtherServices"><a href="#SystemServer-startOtherServices" class="headerlink" title="SystemServer.startOtherServices"></a>SystemServer.startOtherServices</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Context context = mSystemContext;</span><br><span class="line">        VibratorService vibrator = <span class="keyword">null</span>;</span><br><span class="line">        DynamicSystemService dynamicSystem = <span class="keyword">null</span>;</span><br><span class="line">        IStorageManager storageManager = <span class="keyword">null</span>;</span><br><span class="line">        NetworkManagementService networkManagement = <span class="keyword">null</span>;</span><br><span class="line">        IpSecService ipSecService = <span class="keyword">null</span>;</span><br><span class="line">        NetworkStatsService networkStats = <span class="keyword">null</span>;</span><br><span class="line">        NetworkPolicyManagerService networkPolicy = <span class="keyword">null</span>;</span><br><span class="line">        ConnectivityService connectivity = <span class="keyword">null</span>;</span><br><span class="line">        NsdService serviceDiscovery = <span class="keyword">null</span>;</span><br><span class="line">        WindowManagerService wm = <span class="keyword">null</span>;</span><br><span class="line">        SerialService serial = <span class="keyword">null</span>;</span><br><span class="line">        NetworkTimeUpdateService networkTimeUpdater = <span class="keyword">null</span>;</span><br><span class="line">        InputManagerService inputManager = <span class="keyword">null</span>;</span><br><span class="line">        TelephonyRegistry telephonyRegistry = <span class="keyword">null</span>;</span><br><span class="line">        ConsumerIrService consumerIr = <span class="keyword">null</span>;</span><br><span class="line">        MmsServiceBroker mmsService = <span class="keyword">null</span>;</span><br><span class="line">        HardwarePropertiesManagerService hardwarePropertiesService = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> disableSystemTextClassifier = SystemProperties.getBoolean(</span><br><span class="line">                <span class="string">"config.disable_systemtextclassifier"</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">boolean</span> disableNetworkTime = SystemProperties.getBoolean(<span class="string">"config.disable_networktime"</span>,</span><br><span class="line">                <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">boolean</span> disableCameraService = SystemProperties.getBoolean(<span class="string">"config.disable_cameraservice"</span>,</span><br><span class="line">                <span class="keyword">false</span>);</span><br><span class="line">  ...</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> String SECONDARY_ZYGOTE_PRELOAD = <span class="string">"SecondaryZygotePreload"</span>;</span><br><span class="line">            mZygotePreload = SystemServerInitThreadPool.get().submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Slog.i(TAG, SECONDARY_ZYGOTE_PRELOAD);</span><br><span class="line">                    TimingsTraceLog traceLog = <span class="keyword">new</span> TimingsTraceLog(</span><br><span class="line">                            SYSTEM_SERVER_TIMING_ASYNC_TAG, Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">                    traceLog.traceBegin(SECONDARY_ZYGOTE_PRELOAD);</span><br><span class="line">                    <span class="keyword">if</span> (!Process.ZYGOTE_PROCESS.preloadDefault(Build.SUPPORTED_32_BIT_ABIS[<span class="number">0</span>])) &#123;</span><br><span class="line">                        Slog.e(TAG, <span class="string">"Unable to preload default resources"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    traceLog.traceEnd();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    Slog.e(TAG, <span class="string">"Exception preloading default resources"</span>, ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, SECONDARY_ZYGOTE_PRELOAD);</span><br><span class="line"></span><br><span class="line">            ServiceManager.addService(<span class="string">"sec_key_att_app_id_provider"</span>,</span><br><span class="line">                    <span class="keyword">new</span> KeyAttestationApplicationIdProviderService(context));</span><br><span class="line">          </span><br><span class="line">            mSystemServiceManager.startService(KeyChainSystemService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            </span><br><span class="line">            ServiceManager.addService(<span class="string">"scheduling_policy"</span>, <span class="keyword">new</span> SchedulingPolicyService());</span><br><span class="line">          ...</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="Launcher"><a href="#Launcher" class="headerlink" title="Launcher"></a>Launcher</h4><p>Launcher是在ActivityManagerService里面启动的，而ActivityManagerService是SystemServer进程执行<code>startBootstrapServices()</code>函数开启的。</p>
<h5 id="SystemServer-startOtherServices-1"><a href="#SystemServer-startOtherServices-1" class="headerlink" title="SystemServer.startOtherServices"></a>SystemServer.startOtherServices</h5><p>SystemServer在开启其他服务时，在执行<code>startOtherServices()</code>方法中调用 <code>mActivityManagerService.systemReady()</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 调用 AMS 的 systemReady 方法</span></span><br><span class="line">    mActivityManagerService.systemReady(() -&gt; &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Making services ready"</span>);</span><br><span class="line">            traceBeginAndSlog(<span class="string">"StartActivityManagerReadyPhase"</span>);</span><br><span class="line">            mSystemServiceManager.startBootPhase(</span><br><span class="line">                    SystemService.PHASE_ACTIVITY_MANAGER_READY);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mActivityManagerService.startObservingNativeCrashes();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                reportWtf(<span class="string">"observing native crashes"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">      ...</span><br><span class="line">         &#125;, BOOT_TIMINGS_TRACE_LOG);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ActivityManagerService-systemReady"><a href="#ActivityManagerService-systemReady" class="headerlink" title="ActivityManagerService. systemReady"></a>ActivityManagerService. systemReady</h5><p>位于<code>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">(<span class="keyword">final</span> Runnable goingCallback, TimingsTraceLog traceLog)</span> </span>&#123;</span><br><span class="line">       ...</span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">int</span> currentUserId = mUserController.getCurrentUserId();</span><br><span class="line">     mBatteryStatsService.noteEvent(BatteryStats.HistoryItem.EVENT_USER_RUNNING_START,</span><br><span class="line">                Integer.toString(currentUserId), currentUserId);</span><br><span class="line">   mBatteryStatsService.noteEvent(BatteryStats.HistoryItem.EVENT_USER_FOREGROUND_START,</span><br><span class="line">                Integer.toString(currentUserId), currentUserId);</span><br><span class="line">        mSystemServiceManager.startUser(currentUserId);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">       ...</span><br><span class="line">            <span class="comment">// Start up initial activity.</span></span><br><span class="line">           <span class="comment">// 启动初始activity</span></span><br><span class="line">            mBooting = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (UserManager.isSplitSystemUser() &amp;&amp;</span><br><span class="line">                    Settings.Secure.getInt(mContext.getContentResolver(),</span><br><span class="line">                         Settings.Secure.USER_SETUP_COMPLETE, <span class="number">0</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">                ComponentName cName = <span class="keyword">new</span> ComponentName(mContext, SystemUserHomeActivity<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    AppGlobals.getPackageManager().setComponentEnabledSetting(cName,</span><br><span class="line">                            PackageManager.COMPONENT_ENABLED_STATE_ENABLED, <span class="number">0</span>,</span><br><span class="line">                            UserHandle.USER_SYSTEM);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> e.rethrowAsRuntimeException();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//启动桌面 Home 应用</span></span><br><span class="line">            mAtmInternal.startHomeOnAllDisplays(currentUserId, <span class="string">"systemReady"</span>);</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ActivityTaskManagerInternal-startHomeOnAllDisplays"><a href="#ActivityTaskManagerInternal-startHomeOnAllDisplays" class="headerlink" title="ActivityTaskManagerInternal.startHomeOnAllDisplays"></a>ActivityTaskManagerInternal.startHomeOnAllDisplays</h5><p>ActivityTaskManagerInternal是Activity任务管理器本地系统服务接口，是一个抽象类，具体实现是</p>
<p><code>ActivityTaskManagerService.LocalService</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalService</span> <span class="keyword">extends</span> <span class="title">ActivityTaskManagerInternal</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">startHomeOnAllDisplays</span><span class="params">(<span class="keyword">int</span> userId, String reason)</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">synchronized</span> (mGlobalLock) &#123;</span><br><span class="line">       	<span class="keyword">return</span> mRootActivityContainer.startHomeOnAllDisplays(userId, reason);</span><br><span class="line">   	&#125;</span><br><span class="line">	&#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="RootActivityContainer-startHomeOnAllDisplays"><a href="#RootActivityContainer-startHomeOnAllDisplays" class="headerlink" title="RootActivityContainer.startHomeOnAllDisplays"></a>RootActivityContainer.startHomeOnAllDisplays</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">startHomeOnAllDisplays</span><span class="params">(<span class="keyword">int</span> userId, String reason)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">boolean</span> homeStarted = <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = mActivityDisplays.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> displayId = mActivityDisplays.get(i).mDisplayId;</span><br><span class="line">           homeStarted |= startHomeOnDisplay(userId, reason, displayId);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> homeStarted;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h5 id="RootActivityContainer-startHomeOnDisplay"><a href="#RootActivityContainer-startHomeOnDisplay" class="headerlink" title="RootActivityContainer.startHomeOnDisplay"></a>RootActivityContainer.startHomeOnDisplay</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">startHomeOnDisplay</span><span class="params">(<span class="keyword">int</span> userId, String reason, <span class="keyword">int</span> displayId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> startHomeOnDisplay(userId, reason, displayId, <span class="keyword">false</span> <span class="comment">/* allowInstrumenting */</span>,</span><br><span class="line">                <span class="keyword">false</span> <span class="comment">/* fromHomeKey */</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="RootActivityContainer-startHomeOnDisplay-1"><a href="#RootActivityContainer-startHomeOnDisplay-1" class="headerlink" title="RootActivityContainer.startHomeOnDisplay"></a>RootActivityContainer.startHomeOnDisplay</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//启动HomeActivity </span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">startHomeOnDisplay</span><span class="params">(<span class="keyword">int</span> userId, String reason, <span class="keyword">int</span> displayId, <span class="keyword">boolean</span> allowInstrumenting,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> fromHomeKey)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Fallback to top focused display if the displayId is invalid.</span></span><br><span class="line">        <span class="keyword">if</span> (displayId == INVALID_DISPLAY) &#123;</span><br><span class="line">            displayId = getTopDisplayFocusedStack().mDisplayId;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Intent homeIntent = <span class="keyword">null</span>;</span><br><span class="line">        ActivityInfo aInfo = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (displayId == DEFAULT_DISPLAY) &#123;</span><br><span class="line">            <span class="comment">//获取homeIntent</span></span><br><span class="line">            homeIntent = mService.getHomeIntent();</span><br><span class="line">            aInfo = resolveHomeActivity(userId, homeIntent);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shouldPlaceSecondaryHomeOnDisplay(displayId)) &#123;</span><br><span class="line">            Pair&lt;ActivityInfo, Intent&gt; info = resolveSecondaryHomeActivity(userId, displayId);</span><br><span class="line">            aInfo = info.first;</span><br><span class="line">            homeIntent = info.second;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (aInfo == <span class="keyword">null</span> || homeIntent == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!canStartHomeOnDisplay(aInfo, displayId, allowInstrumenting)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Updates the home component of the intent.</span></span><br><span class="line">        homeIntent.setComponent(<span class="keyword">new</span> ComponentName(aInfo.applicationInfo.packageName, aInfo.name));</span><br><span class="line">        homeIntent.setFlags(homeIntent.getFlags() | FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">        <span class="comment">// Updates the extra information of the intent.</span></span><br><span class="line">        <span class="keyword">if</span> (fromHomeKey) &#123;</span><br><span class="line">            homeIntent.putExtra(WindowManagerPolicy.EXTRA_FROM_HOME_KEY, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Update the reason for ANR debugging to verify if the user activity is the one that</span></span><br><span class="line">        <span class="comment">// actually launched.</span></span><br><span class="line">        <span class="keyword">final</span> String myReason = reason + <span class="string">":"</span> + userId + <span class="string">":"</span> + UserHandle.getUserId(</span><br><span class="line">                aInfo.applicationInfo.uid) + <span class="string">":"</span> + displayId;</span><br><span class="line">        <span class="comment">// 启动桌面 Activity</span></span><br><span class="line">        mService.getActivityStartController().startHomeActivity(homeIntent, aInfo, myReason,</span><br><span class="line">                displayId);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="ActivityTaskManagerService-getHomeIntent"><a href="#ActivityTaskManagerService-getHomeIntent" class="headerlink" title="ActivityTaskManagerService.getHomeIntent"></a>ActivityTaskManagerService.getHomeIntent</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Intent <span class="title">getHomeIntent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(mTopAction, mTopData != <span class="keyword">null</span> ? Uri.parse(mTopData) : <span class="keyword">null</span>);</span><br><span class="line">        intent.setComponent(mTopComponent);</span><br><span class="line">        intent.addFlags(Intent.FLAG_DEBUG_TRIAGED_MISSING);</span><br><span class="line">        <span class="keyword">if</span> (mFactoryTest != FactoryTest.FACTORY_TEST_LOW_LEVEL) &#123;</span><br><span class="line">            intent.addCategory(Intent.CATEGORY_HOME);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> intent;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="ActivityStartController-startHomeActivity"><a href="#ActivityStartController-startHomeActivity" class="headerlink" title="ActivityStartController.startHomeActivity"></a>ActivityStartController.startHomeActivity</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startHomeActivity</span><span class="params">(Intent intent, ActivityInfo aInfo, String reason, <span class="keyword">int</span> displayId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityOptions options = ActivityOptions.makeBasic();</span><br><span class="line">        options.setLaunchWindowingMode(WINDOWING_MODE_FULLSCREEN);</span><br><span class="line">        <span class="keyword">if</span> (!ActivityRecord.isResolverActivity(aInfo.name)) &#123;</span><br><span class="line">            <span class="comment">// The resolver activity shouldn't be put in home stack because when the foreground is</span></span><br><span class="line">            <span class="comment">// standard type activity, the resolver activity should be put on the top of current</span></span><br><span class="line">            <span class="comment">// foreground instead of bring home stack to front.</span></span><br><span class="line">            options.setLaunchActivityType(ACTIVITY_TYPE_HOME);</span><br><span class="line">        &#125;</span><br><span class="line">        options.setLaunchDisplayId(displayId);</span><br><span class="line">        mLastHomeActivityStartResult = obtainStarter(intent, <span class="string">"startHomeActivity: "</span> + reason)</span><br><span class="line">                .setOutActivity(tmpOutRecord)</span><br><span class="line">                .setCallingUid(<span class="number">0</span>)</span><br><span class="line">                .setActivityInfo(aInfo)</span><br><span class="line">                .setActivityOptions(options.toBundle())</span><br><span class="line">                .execute();</span><br><span class="line">        mLastHomeActivityStartRecord = tmpOutRecord[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">final</span> ActivityDisplay display =</span><br><span class="line">                mService.mRootActivityContainer.getActivityDisplay(displayId);</span><br><span class="line">        <span class="keyword">final</span> ActivityStack homeStack = display != <span class="keyword">null</span> ? display.getHomeStack() : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (homeStack != <span class="keyword">null</span> &amp;&amp; homeStack.mInResumeTopActivity) &#123;</span><br><span class="line">            <span class="comment">// If we are in resume section already, home activity will be initialized, but not</span></span><br><span class="line">            <span class="comment">// resumed (to avoid recursive resume) and will stay that way until something pokes it</span></span><br><span class="line">            <span class="comment">// again. We need to schedule another resume.</span></span><br><span class="line">            mSupervisor.scheduleResumeTopActivities();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="ActivityStarter-execute"><a href="#ActivityStarter-execute" class="headerlink" title="ActivityStarter.execute"></a>ActivityStarter.execute</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// TODO(b/64750076): Look into passing request directly to these methods to allow</span></span><br><span class="line">            <span class="comment">// for transactional diffs and preprocessing.</span></span><br><span class="line">            <span class="keyword">if</span> (mRequest.mayWait) &#123;</span><br><span class="line">                <span class="keyword">return</span> startActivityMayWait(mRequest.caller, mRequest.callingUid,</span><br><span class="line">                        mRequest.callingPackage, mRequest.realCallingPid, mRequest.realCallingUid,</span><br><span class="line">                        mRequest.intent, mRequest.resolvedType,</span><br><span class="line">                        mRequest.voiceSession, mRequest.voiceInteractor, mRequest.resultTo,</span><br><span class="line">                        mRequest.resultWho, mRequest.requestCode, mRequest.startFlags,</span><br><span class="line">                        mRequest.profilerInfo, mRequest.waitResult, mRequest.globalConfig,</span><br><span class="line">                        mRequest.activityOptions, mRequest.ignoreTargetSecurity, mRequest.userId,</span><br><span class="line">                        mRequest.inTask, mRequest.reason,</span><br><span class="line">                        mRequest.allowPendingRemoteAnimationRegistryLookup,</span><br><span class="line">                        mRequest.originatingPendingIntent, mRequest.allowBackgroundActivityStart);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> startActivity(mRequest.caller, mRequest.intent, mRequest.ephemeralIntent,</span><br><span class="line">                        mRequest.resolvedType, mRequest.activityInfo, mRequest.resolveInfo,</span><br><span class="line">                        mRequest.voiceSession, mRequest.voiceInteractor, mRequest.resultTo,</span><br><span class="line">                        mRequest.resultWho, mRequest.requestCode, mRequest.callingPid,</span><br><span class="line">                        mRequest.callingUid, mRequest.callingPackage, mRequest.realCallingPid,</span><br><span class="line">                        mRequest.realCallingUid, mRequest.startFlags, mRequest.activityOptions,</span><br><span class="line">                        mRequest.ignoreTargetSecurity, mRequest.componentSpecified,</span><br><span class="line">                        mRequest.outActivity, mRequest.inTask, mRequest.reason,</span><br><span class="line">                        mRequest.allowPendingRemoteAnimationRegistryLookup,</span><br><span class="line">                        mRequest.originatingPendingIntent, mRequest.allowBackgroundActivityStart);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            onExecutionComplete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="ActivityStarter-startActivity"><a href="#ActivityStarter-startActivity" class="headerlink" title="ActivityStarter.startActivity"></a>ActivityStarter.startActivity</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span></span></span><br><span class="line"><span class="function"><span class="params">            String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">            String callingPackage, <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            SafeActivityOptions options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified,</span></span></span><br><span class="line"><span class="function"><span class="params">            ActivityRecord[] outActivity, TaskRecord inTask, String reason,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> allowPendingRemoteAnimationRegistryLookup,</span></span></span><br><span class="line"><span class="function"><span class="params">            PendingIntentRecord originatingPendingIntent, <span class="keyword">boolean</span> allowBackgroundActivityStart)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(reason)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Need to specify a reason."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mLastStartReason = reason;</span><br><span class="line">        mLastStartActivityTimeMs = System.currentTimeMillis();</span><br><span class="line">        mLastStartActivityRecord[<span class="number">0</span>] = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        mLastStartActivityResult = startActivity(caller, intent, ephemeralIntent, resolvedType,</span><br><span class="line">                aInfo, rInfo, voiceSession, voiceInteractor, resultTo, resultWho, requestCode,</span><br><span class="line">                callingPid, callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,</span><br><span class="line">                options, ignoreTargetSecurity, componentSpecified, mLastStartActivityRecord,</span><br><span class="line">                inTask, allowPendingRemoteAnimationRegistryLookup, originatingPendingIntent,</span><br><span class="line">                allowBackgroundActivityStart);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (outActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// mLastStartActivityRecord[0] is set in the call to startActivity above.</span></span><br><span class="line">            outActivity[<span class="number">0</span>] = mLastStartActivityRecord[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> getExternalResult(mLastStartActivityResult);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>最后，从整体上来看 Android 系统的启动流程：</p>
<ol>
<li>按下电源，固化在 ROM 中预定位置的 Bootloader 将会被加载到内存中</li>
<li>Bootloader 初始化完软硬件环境后将 Linux 内核启动起来</li>
<li>Linux 内核启动时会做设置缓存、被保护存储器、计划列表和加载驱动等一些列操作，内核启动完成后会启动 init 进程</li>
<li>init 进程会初始化并启动属性服务，并且解析并执行所有 init.rc 文件</li>
<li>init 通过执行特定的 init.rc 文件启动 servermanager 进程，servermanager 被启动后会向 Binder 驱动发送命令让自己成为守护进程并管理所有上下文</li>
<li>init 通过解析 init.rc 文件启动 zygote 进程</li>
<li>zygote 进程启动的过程会创建 DVM 并为其注册 JNI 函数，然后创建服务端 Socket、启动 system_server 进程</li>
<li>启动 system_server 进程的过程会创建 Binder 线程池使其具有 IPC 能力，然后启动 AMS 等各种系统服务</li>
<li>AMS 启动 Launcher，Launcher 被启动后会将已安装应用的图标显示在界面上</li>
</ol>
<p>引用文章：</p>
<blockquote>
<p><a href="https://www.jianshu.com/p/9f978d57c683" target="_blank" rel="noopener">Android启动流程之bootloader引导与Linux启动</a></p>
<p><a href="https://juejin.im/post/6844903958410952717#heading-6" target="_blank" rel="noopener">Android10.0系统启动流程（三）：Zygote</a></p>
<p><a href="http://gityuan.com/2016/02/01/android-booting/" target="_blank" rel="noopener">Android系统启动-综述</a></p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag"># Android源码分析</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/08/12/Binder%E6%9C%BA%E5%88%B6/" rel="prev" title="Binder机制">
      <i class="fa fa-chevron-left"></i> Binder机制
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/08/16/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8-Init%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8/" rel="next" title="Android系统启动-Init进程启动">
      Android系统启动-Init进程启动 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



        </div>
        

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">prsuit</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"wcHVHcMfvijlbh1aHD87HwFg-gzGzoHsz","app_key":"LuS6lIabezmhCePy6QOd6WnR","server_url":"https://prsuit.github.io/","security":false};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
